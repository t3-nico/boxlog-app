#!/usr/bin/env node
/**
 * ã‚¹ãƒãƒ¼ãƒˆnpmã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ©ãƒ³ãƒŠãƒ¼
 *
 * ç’°å¢ƒã«å¿œã˜ãŸæŸ”è»Ÿãªã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚’æä¾›
 */

const { execSync } = require('child_process')
const fs = require('fs')

class SmartRunner {
  constructor() {
    this.fallbackMode = false
  }

  /**
   * ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
   */
  async smartRun(scriptName, args = []) {
    console.log(`ğŸš€ Smart running: ${scriptName}`)

    // .env.localã®å­˜åœ¨ç¢ºèª
    if (!fs.existsSync('.env.local')) {
      console.log('âš ï¸  .env.local not found. Creating template...')
      this.createFallbackEnv()
    }

    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
    const fallbackScript = this.getFallbackScript(scriptName)
    const command = this.buildCommand(fallbackScript, args)

    try {
      const result = execSync(command, {
        stdio: 'inherit',
        env: { ...process.env, NODE_ENV: process.env.NODE_ENV || 'development' }
      })

      return result
    } catch (error) {
      console.error(`âŒ Failed to execute: ${command}`)
      process.exit(1)
    }
  }

  /**
   * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç’°å¢ƒãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
   */
  createFallbackEnv() {
    const template = `# BoxLog Development Environment
# Auto-generated by smart-run
# Copy from .env.example and add your values

NODE_ENV=development

# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# PostgreSQL
DATABASE_URL=

# Sentry
SENTRY_DSN=
SENTRY_AUTH_TOKEN=

# Feature Flags
NEXT_PUBLIC_ENABLE_AI_CHAT=false
`

    fs.writeFileSync('.env.local', template)
    console.log('âœ… Created .env.local template')
    console.log('ğŸ“ Please fill in your environment variables in .env.local')
  }

  /**
   * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°
   */
  getFallbackScript(scriptName) {
    const scriptMap = {
      'dev:secure': 'dev',
      'build:secure': 'build',
      'test:secure': 'test',
      'db:migrate:secure': 'db:migrate'
    }

    return scriptMap[scriptName] || scriptName
  }

  /**
   * ã‚³ãƒãƒ³ãƒ‰æ§‹ç¯‰
   */
  buildCommand(scriptName, args) {
    const argsString = args.join(' ')
    return `npm run ${scriptName} ${argsString}`.trim()
  }

  /**
   * ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãŒå¿…è¦ãªã‚³ãƒãƒ³ãƒ‰ã‹ãƒã‚§ãƒƒã‚¯
   */
  isStreamingCommand(scriptName) {
    const streamingCommands = ['dev', 'dev:secure', 'test:watch', 'storybook']
    return streamingCommands.includes(scriptName)
  }
}

// CLIå®Ÿè¡Œ
if (require.main === module) {
  const args = process.argv.slice(2)
  const scriptName = args[0]
  const scriptArgs = args.slice(1)

  if (!scriptName) {
    console.error('âŒ Script name required')
    console.log(`
Usage: npm run smart <script-name> [args...]

Examples:
  npm run smart dev
  npm run smart build
  npm run smart test

Available scripts:
  - dev     : Start development server
  - build   : Build for production
  - test    : Run tests
`)
    process.exit(1)
  }

  const runner = new SmartRunner()
  runner.smartRun(scriptName, scriptArgs).catch(error => {
    console.error('âŒ Execution failed:', error.message)
    process.exit(1)
  })
}

module.exports = SmartRunner
