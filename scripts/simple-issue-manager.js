#!/usr/bin/env node

/**
 * Simple Issue Manager
 * ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œã‚‰ãšã«Issueç®¡ç†ã®ã¿ã‚’è¡Œã†ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

const colors = {
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  green: '\x1b[32m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
  gray: '\x1b[90m',
  reset: '\x1b[0m',
  bold: '\x1b[1m',
};

const CONFIG_FILE = path.join(process.cwd(), '.claude', 'claude-config.json');
const SESSION_FILE = path.join(process.cwd(), '.claude-session.json');

function loadConfig() {
  try {
    return JSON.parse(fs.readFileSync(CONFIG_FILE, 'utf8'));
  } catch {
    console.error(`${colors.red}âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${CONFIG_FILE}${colors.reset}`);
    process.exit(1);
  }
}

function saveSession(session) {
  fs.writeFileSync(SESSION_FILE, JSON.stringify(session, null, 2));
}

function loadSession() {
  try {
    return JSON.parse(fs.readFileSync(SESSION_FILE, 'utf8'));
  } catch {
    return null;
  }
}

function createIssue(title, priority = 'medium', size = 'medium', labels = []) {
  const config = loadConfig();

  // ãƒ©ãƒ™ãƒ«ã‚’æ§‹ç¯‰
  const priorityLabel = config.labels.priorityMapping[priority] || 'P2-medium';
  const sizeLabel = config.labels.sizeMapping[size] || 'size-M';
  const allLabels = [...config.labels.default, priorityLabel, sizeLabel, 'ready', ...labels].join(
    ',',
  );

  const body = `## ğŸ¯ ä½œæ¥­å†…å®¹
${title}

## ğŸ“‹ ã‚¿ã‚¹ã‚¯
- [ ] è¦ä»¶åˆ†æãƒ»è¨­è¨ˆ
- [ ] å®Ÿè£…
- [ ] ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

## ğŸ“ é€²æ—ãƒ­ã‚°
*é€²æ—ãƒ»é‡è¦ãªæ„æ€æ±ºå®šãƒ»å¤‰æ›´ç‚¹ã‚’ã“ã“ã«è¨˜éŒ²*

---
**ğŸ¤– Generated by Simple Issue Manager**`;

  try {
    console.log(`${colors.blue}ğŸ“ Issueä½œæˆä¸­: ${colors.reset}${title}`);

    const result = execSync(
      `gh issue create --title "${title}" --body "${body}" --label "${allLabels}"`,
      {
        encoding: 'utf8',
        cwd: process.cwd(),
      },
    );

    const issueUrl = result.trim();
    const issueNumber = issueUrl.split('/').pop();

    console.log(`${colors.green}âœ… Issue #${issueNumber} ä½œæˆå®Œäº†: ${colors.reset}${issueUrl}`);

    return {
      number: issueNumber,
      url: issueUrl,
      title: title,
      createdAt: new Date().toISOString(),
    };
  } catch (error) {
    console.error(`${colors.red}âŒ Issueä½œæˆã‚¨ãƒ©ãƒ¼: ${colors.reset}${error.message}`);
    return null;
  }
}

function getCurrentBranch() {
  try {
    return execSync('git branch --show-current', { encoding: 'utf8' }).trim();
  } catch {
    return 'unknown';
  }
}

function getLastCommit() {
  try {
    return execSync('git log -1 --pretty=format:"%h - %s"', { encoding: 'utf8' }).trim();
  } catch {
    return 'No commits yet';
  }
}

function startSession(title, options = {}) {
  loadConfig();

  // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
  const existingSession = loadSession();
  if (existingSession && !options.force) {
    console.log(
      `${colors.yellow}âš ï¸  é€²è¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™: Issue #${existingSession.issueNumber}${colors.reset}`,
    );
    console.log(`   ã‚¿ã‚¤ãƒˆãƒ«: ${existingSession.title}`);
    console.log(`   é–‹å§‹æ™‚é–“: ${existingSession.startTime}`);
    console.log(`\nç¶šè¡Œã™ã‚‹å ´åˆã¯ --force ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„`);
    return;
  }

  // ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã‚’å–å¾—
  const currentBranch = getCurrentBranch();
  const lastCommit = getLastCommit();

  // Issueä½œæˆ
  const issue = createIssue(title, options.priority, options.size, options.labels);
  if (!issue) {
    console.error(`${colors.red}âŒ Issueã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ${colors.reset}`);
    return;
  }

  // åˆæœŸãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã‚’Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
  const branchInfoComment = `## ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±

**é–‹å§‹ãƒ–ãƒ©ãƒ³ãƒ**: \`${currentBranch}\`  
**æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ**: \`${lastCommit}\`  
**é–‹å§‹æ™‚é–“**: ${new Date().toLocaleString('ja-JP')}

---
*Branch tracking by Simple Issue Manager*`;

  try {
    execSync(`gh issue comment ${issue.number} --body "${branchInfoComment}"`, {
      encoding: 'utf8',
      cwd: process.cwd(),
    });
  } catch {
    console.warn(`${colors.yellow}âš ï¸  ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ${colors.reset}`);
  }

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ä¿å­˜
  const session = {
    issueNumber: issue.number,
    issueUrl: issue.url,
    title: title,
    startTime: new Date().toISOString(),
    currentBranch: currentBranch,
    startCommit: lastCommit,
  };

  saveSession(session);

  console.log(`\n${colors.green}âœ… ä½œæ¥­ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹å®Œäº†ï¼${colors.reset}`);
  console.log(`   ğŸ“‹ Issue: #${issue.number}`);
  console.log(`   ğŸŒ¿ ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: ${currentBranch}`);
  console.log(`   ğŸ“ æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ: ${lastCommit}`);

  console.log(`\nğŸ”— æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰:`);
  console.log(`   é€²æ—æ›´æ–°: npm run issue:progress "<é€²æ—å†…å®¹>"`);
  console.log(`   é‡è¦ãƒ¡ãƒ¢: npm run issue:note "<é‡è¦ãªè¨˜éŒ²>"`);
  console.log(`   å®Œäº†: npm run issue:complete`);

  console.log(`\nğŸ’¡ ã‚³ãƒŸãƒƒãƒˆæ™‚ã®æ³¨æ„:`);
  console.log(`   Issueé€£æºã®ãŸã‚ã€ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã« #${issue.number} ã‚’å«ã‚ã¦ãã ã•ã„`);
  console.log(`   ä¾‹: git commit -m "feat: æ–°æ©Ÿèƒ½å®Ÿè£… #${issue.number}"`);
}

function updateProgress(message) {
  const session = loadSession();
  if (!session) {
    console.error(`${colors.red}âŒ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“${colors.reset}`);
    return;
  }

  try {
    console.log(`${colors.blue}ğŸ“ é€²æ—æ›´æ–°ä¸­: Issue #${session.issueNumber}${colors.reset}`);

    const currentBranch = getCurrentBranch();
    const lastCommit = getLastCommit();

    const progressComment = `## ğŸ“ é€²æ—æ›´æ–° - ${new Date().toLocaleString('ja-JP')}

${message}

### ğŸŒ¿ ç¾åœ¨ã®çŠ¶æ³
- **ãƒ–ãƒ©ãƒ³ãƒ**: \`${currentBranch}\`
- **æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ**: \`${lastCommit}\`

---
*Updated by Simple Issue Manager*`;

    execSync(`gh issue comment ${session.issueNumber} --body "${progressComment}"`, {
      encoding: 'utf8',
      cwd: process.cwd(),
    });

    console.log(`${colors.green}âœ… é€²æ—ã‚’æ›´æ–°ã—ã¾ã—ãŸ${colors.reset}`);
    console.log(`   ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${currentBranch}`);
    console.log(`   ğŸ“ æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ: ${lastCommit}`);
  } catch (error) {
    console.error(`${colors.red}âŒ é€²æ—æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${colors.reset}${error.message}`);
  }
}

function addNote(note) {
  const session = loadSession();
  if (!session) {
    console.error(`${colors.red}âŒ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“${colors.reset}`);
    return;
  }

  try {
    console.log(`${colors.blue}ğŸ“ ãƒ¡ãƒ¢è¿½åŠ ä¸­: Issue #${session.issueNumber}${colors.reset}`);

    const noteComment = `## ğŸ’¡ é‡è¦ãƒ¡ãƒ¢ - ${new Date().toLocaleString('ja-JP')}

${note}

---
*Added by Simple Issue Manager*`;

    execSync(`gh issue comment ${session.issueNumber} --body "${noteComment}"`, {
      encoding: 'utf8',
      cwd: process.cwd(),
    });

    console.log(`${colors.green}âœ… ãƒ¡ãƒ¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ${colors.reset}`);
  } catch (error) {
    console.error(`${colors.red}âŒ ãƒ¡ãƒ¢è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${colors.reset}${error.message}`);
  }
}

function completeSession() {
  const session = loadSession();
  if (!session) {
    console.error(`${colors.red}âŒ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“${colors.reset}`);
    return;
  }

  try {
    const endTime = new Date().toISOString();
    const startTime = new Date(session.startTime);
    const duration = Math.floor((new Date(endTime) - startTime) / (1000 * 60)); // åˆ†å˜ä½

    const currentBranch = getCurrentBranch();
    const lastCommit = getLastCommit();

    console.log(`${colors.blue}ğŸ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†å‡¦ç†ä¸­...${colors.reset}`);

    const completionComment = `## âœ… ä½œæ¥­ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº† - ${new Date().toLocaleString('ja-JP')}

### ğŸ“Š ä½œæ¥­ã‚µãƒãƒªãƒ¼
- **é–‹å§‹æ™‚é–“**: ${new Date(session.startTime).toLocaleString('ja-JP')}
- **çµ‚äº†æ™‚é–“**: ${new Date(endTime).toLocaleString('ja-JP')}
- **ä½œæ¥­æ™‚é–“**: ${Math.floor(duration / 60)}æ™‚é–“${duration % 60}åˆ†

### ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒãƒ»ã‚³ãƒŸãƒƒãƒˆæƒ…å ±
- **é–‹å§‹ãƒ–ãƒ©ãƒ³ãƒ**: \`${session.currentBranch || 'unknown'}\`
- **å®Œäº†ãƒ–ãƒ©ãƒ³ãƒ**: \`${currentBranch}\`
- **é–‹å§‹ã‚³ãƒŸãƒƒãƒˆ**: \`${session.startCommit || 'unknown'}\`
- **æœ€çµ‚ã‚³ãƒŸãƒƒãƒˆ**: \`${lastCommit}\`

### ğŸ”— æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- ãƒ¬ãƒ“ãƒ¥ãƒ¼: \`gh issue view ${session.issueNumber}\`
- æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³: \`npm run issue:start "<æ¬¡ã®ä½œæ¥­>"\`

---
**ğŸ¤– Generated by Simple Issue Manager**`;

    execSync(`gh issue comment ${session.issueNumber} --body "${completionComment}"`, {
      encoding: 'utf8',
      cwd: process.cwd(),
    });

    console.log(`${colors.green}âœ… ä½œæ¥­ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼${colors.reset}`);
    console.log(`   ğŸ“‹ Issue: #${session.issueNumber}`);
    console.log(`   â±ï¸  ä½œæ¥­æ™‚é–“: ${Math.floor(duration / 60)}æ™‚é–“${duration % 60}åˆ†`);
    console.log(`   ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${session.currentBranch} â†’ ${currentBranch}`);
    console.log(`   ğŸ“ å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ: Issue ã«è©³ç´°è¨˜éŒ²æ¸ˆã¿`);

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    fs.unlinkSync(SESSION_FILE);

    console.log(`\nğŸ”— æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:`);
    console.log(`   ãƒ¬ãƒ“ãƒ¥ãƒ¼: gh issue view ${session.issueNumber}`);
    console.log(`   æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³: npm run issue:start "<æ¬¡ã®ä½œæ¥­>"`);
  } catch (error) {
    console.error(`${colors.red}âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ã‚¨ãƒ©ãƒ¼: ${colors.reset}${error.message}`);
  }
}

function showStatus() {
  const session = loadSession();
  if (!session) {
    console.log(`${colors.gray}ğŸ“‹ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“${colors.reset}`);
    return;
  }

  const startTime = new Date(session.startTime);
  const duration = Math.floor((new Date() - startTime) / (1000 * 60));
  const currentBranch = getCurrentBranch();
  const lastCommit = getLastCommit();

  console.log(`${colors.bold}${colors.blue}ğŸ“‹ ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³${colors.reset}`);
  console.log(`   Issue: #${session.issueNumber}`);
  console.log(`   ã‚¿ã‚¤ãƒˆãƒ«: ${session.title}`);
  console.log(`   é–‹å§‹æ™‚é–“: ${startTime.toLocaleString('ja-JP')}`);
  console.log(`   çµŒéæ™‚é–“: ${Math.floor(duration / 60)}æ™‚é–“${duration % 60}åˆ†`);
  console.log(`   URL: ${session.issueUrl}`);

  console.log(`\n${colors.bold}ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±${colors.reset}`);
  console.log(`   é–‹å§‹ãƒ–ãƒ©ãƒ³ãƒ: ${session.currentBranch || 'unknown'}`);
  console.log(`   ç¾åœ¨ãƒ–ãƒ©ãƒ³ãƒ: ${currentBranch}`);
  console.log(`   é–‹å§‹ã‚³ãƒŸãƒƒãƒˆ: ${session.startCommit || 'unknown'}`);
  console.log(`   æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ: ${lastCommit}`);
}

function showHelp() {
  console.log(`
${colors.bold}Simple Issue Manager${colors.reset}

${colors.bold}ä½¿ç”¨æ–¹æ³•:${colors.reset}
  node scripts/simple-issue-manager.js <ã‚³ãƒãƒ³ãƒ‰> [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]

${colors.bold}ã‚³ãƒãƒ³ãƒ‰:${colors.reset}
  start <ã‚¿ã‚¤ãƒˆãƒ«>     æ–°ã—ã„Issueã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
  progress <ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸> é€²æ—ã‚’æ›´æ–°
  note <ãƒ¡ãƒ¢>         é‡è¦ãªãƒ¡ãƒ¢ã‚’è¿½åŠ 
  complete           ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Œäº†
  status             ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ³ã‚’è¡¨ç¤º
  help               ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

${colors.bold}startã‚³ãƒãƒ³ãƒ‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³:${colors.reset}
  --priority <level>  å„ªå…ˆåº¦ (urgent, high, medium, low)
  --size <size>      ä½œæ¥­è¦æ¨¡ (tiny, small, medium, large)
  --label <label>    è¿½åŠ ãƒ©ãƒ™ãƒ« (è¤‡æ•°æŒ‡å®šå¯èƒ½)
  --force           æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¼·åˆ¶çµ‚äº†ã—ã¦é–‹å§‹

${colors.bold}ä¾‹:${colors.reset}
  ${colors.gray}# æ–°ã—ã„ä½œæ¥­ã‚’é–‹å§‹${colors.reset}
  node scripts/simple-issue-manager.js start "TODOçµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å®Œæˆ"
  
  ${colors.gray}# å„ªå…ˆåº¦ã¨ã‚µã‚¤ã‚ºã‚’æŒ‡å®š${colors.reset}
  node scripts/simple-issue-manager.js start "ãƒã‚°ä¿®æ­£" --priority high --size small
  
  ${colors.gray}# é€²æ—æ›´æ–°${colors.reset}
  node scripts/simple-issue-manager.js progress "åŸºæœ¬æ©Ÿèƒ½ã®å®Ÿè£…å®Œäº†"
  
  ${colors.gray}# ä½œæ¥­å®Œäº†${colors.reset}
  node scripts/simple-issue-manager.js complete

${colors.bold}ç‰¹å¾´:${colors.reset}
  âœ… ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã›ãšã€æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã§ä½œæ¥­
  âœ… Issueä½œæˆã¨ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°ã®ã¿
  âœ… ã‚·ãƒ³ãƒ—ãƒ«ã§è»½é‡
  âœ… GitHub CLI (gh) å¿…é ˆ
`);
}

// ã‚³ãƒãƒ³ãƒ‰è§£æ
function parseStartCommand(commandArgs) {
  if (commandArgs.length === 0) {
    console.error(`${colors.red}âŒ ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„${colors.reset}`);
    return null;
  }

  const title = commandArgs[0];
  const options = {
    priority: 'medium',
    size: 'medium',
    labels: [],
    force: false,
  };

  for (let i = 1; i < commandArgs.length; i++) {
    switch (commandArgs[i]) {
      case '--priority':
        options.priority = commandArgs[++i];
        break;
      case '--size':
        options.size = commandArgs[++i];
        break;
      case '--label':
        options.labels.push(commandArgs[++i]);
        break;
      case '--force':
        options.force = true;
        break;
    }
  }

  return { title, options };
}

// ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
function executeCommand(command, commandArgs) {
  switch (command) {
    case 'start': {
      const parsed = parseStartCommand(commandArgs);
      if (parsed) {
        startSession(parsed.title, parsed.options);
      }
      break;
    }

    case 'progress': {
      if (commandArgs.length === 0) {
        console.error(`${colors.red}âŒ é€²æ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒ‡å®šã—ã¦ãã ã•ã„${colors.reset}`);
        return;
      }
      updateProgress(commandArgs[0]);
      break;
    }

    case 'note': {
      if (commandArgs.length === 0) {
        console.error(`${colors.red}âŒ ãƒ¡ãƒ¢å†…å®¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„${colors.reset}`);
        return;
      }
      addNote(commandArgs[0]);
      break;
    }

    case 'complete':
      completeSession();
      break;

    case 'status':
      showStatus();
      break;

    case 'help':
    case '--help':
    case '-h':
      showHelp();
      break;

    default:
      console.error(`${colors.red}âŒ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: ${command}${colors.reset}`);
      showHelp();
  }
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
function main() {
  const args = process.argv.slice(2);

  if (args.length === 0) {
    showHelp();
    return;
  }

  const command = args[0];
  const commandArgs = args.slice(1);

  executeCommand(command, commandArgs);
}

if (require.main === module) {
  main();
}

module.exports = {
  createIssue,
  startSession,
  updateProgress,
  addNote,
  completeSession,
  showStatus,
};
