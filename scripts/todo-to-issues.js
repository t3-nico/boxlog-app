#!/usr/bin/env node

/**
 * TODO â†’ GitHub Issues è‡ªå‹•å¤‰æ›ã‚·ã‚¹ãƒ†ãƒ 
 *
 * æ—¢å­˜ã®TODOã‚³ãƒ¡ãƒ³ãƒˆã‚’GitHub Issueã«è‡ªå‹•å¤‰æ›ã—ã€
 * Issueç•ªå·ã¨TODOã‚³ãƒ¡ãƒ³ãƒˆã‚’ç´ä»˜ã‘ã‚‹çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
 */

const { execSync } = require('child_process')
const fs = require('fs')
const path = require('path')

// æ—¢å­˜ã®TODOç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const { analyzeTodosInFile } = require('./todo-manager.js')

// ğŸ¨ ã‚«ãƒ©ãƒ¼å‡ºåŠ›
const colors = {
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  green: '\x1b[32m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
  gray: '\x1b[90m',
  reset: '\x1b[0m',
  bold: '\x1b[1m',
}

/**
 * TODOã®å„ªå…ˆåº¦ã‚’åˆ†æã—ã¦åˆ¤å®š
 */
function analyzeTodoPriority(todo) {
  const text = todo.text.toLowerCase()
  const file = todo.file.toLowerCase()

  // P0: ç·Šæ€¥åº¦ãŒé«˜ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
  if (text.includes('urgent') || text.includes('critical') || text.includes('hotfix') || text.includes('ç·Šæ€¥')) {
    return 'P0-urgent'
  }

  // P1: é«˜å„ªå…ˆåº¦ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ç ´å£Šçš„å¤‰æ›´ï¼‰
  if (
    text.includes('security') ||
    text.includes('performance') ||
    text.includes('breaking') ||
    text.includes('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£') ||
    text.includes('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹') ||
    text.includes('ç ´å£Šçš„')
  ) {
    return 'P1-high'
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹å„ªå…ˆåº¦åˆ¤å®š
  if (file.includes('eslint') || file.includes('config') || file.includes('script')) {
    return 'P2-medium'
  }

  return 'P3-low'
}

/**
 * TODOã®ã‚µã‚¤ã‚ºã‚’è¦‹ç©ã‚‚ã‚Š
 */
function estimateTodoSize(todo) {
  const text = todo.text.toLowerCase()

  // size-XS: ç°¡å˜ãªä¿®æ­£ãƒ»å‰Šé™¤
  if (
    text.includes('remove') ||
    text.includes('delete') ||
    text.includes('fix typo') ||
    text.includes('å‰Šé™¤') ||
    text.includes('ä¿®æ­£')
  ) {
    return 'size-XS'
  }

  // size-L: å¤§è¦æ¨¡å®Ÿè£…
  if (
    text.includes('implement') ||
    text.includes('create') ||
    text.includes('build') ||
    text.includes('å®Ÿè£…') ||
    text.includes('ä½œæˆ') ||
    text.includes('æ§‹ç¯‰')
  ) {
    return 'size-L'
  }

  // size-S: å°è¦æ¨¡ä¿®æ­£ãƒ»æ”¹å–„
  if (
    text.includes('improve') ||
    text.includes('optimize') ||
    text.includes('refactor') ||
    text.includes('æ”¹å–„') ||
    text.includes('æœ€é©åŒ–') ||
    text.includes('ãƒªãƒ•ã‚¡ã‚¯ã‚¿')
  ) {
    return 'size-S'
  }

  return 'size-M' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
}

/**
 * TODOã®ã‚«ãƒ†ã‚´ãƒªã‚’åˆ¤å®š
 */
function categorizeTodo(todo) {
  const text = todo.text.toLowerCase()
  const file = todo.file.toLowerCase()

  const categories = []

  // æŠ€è¡“é ˜åŸŸã«ã‚ˆã‚‹åˆ†é¡
  if (file.includes('test') || text.includes('test')) categories.push('test')
  if (file.includes('doc') || text.includes('document')) categories.push('docs')
  if (file.includes('ui') || file.includes('component')) categories.push('ui', 'frontend')
  if (file.includes('api') || file.includes('server')) categories.push('api', 'backend')
  if (file.includes('security') || text.includes('security')) categories.push('security')
  if (file.includes('performance') || text.includes('performance')) categories.push('performance')
  if (file.includes('accessibility') || text.includes('a11y')) categories.push('accessibility')

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  if (categories.length === 0) {
    if (file.includes('.tsx') || file.includes('.jsx')) categories.push('frontend')
    else if (file.includes('.js') || file.includes('.ts')) categories.push('refactor')
    else categories.push('feature')
  }

  return categories
}

/**
 * GitHub Issueæœ¬æ–‡ã‚’ç”Ÿæˆ
 */
function generateIssueBody(todo, relatedTodos = []) {
  const priority = analyzeTodoPriority(todo)
  const size = estimateTodoSize(todo)
  const categories = categorizeTodo(todo)

  const body = `## ğŸ¯ ç›®æ¨™
${todo.text}

## ğŸ“ å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
\`${todo.file}:${todo.line}\`

## ğŸ“‹ å®Ÿè£…å†…å®¹
- [ ] ${todo.text}

## ğŸ”— é–¢é€£æƒ…å ±
- **ãƒ•ã‚¡ã‚¤ãƒ«**: ${todo.file}
- **è¡Œ**: ${todo.line}
- **ã‚¿ã‚¤ãƒ—**: ${todo.type}
- **å„ªå…ˆåº¦**: ${priority}
- **è¦æ¨¡**: ${size}
- **ã‚«ãƒ†ã‚´ãƒª**: ${categories.join(', ')}

${
  relatedTodos.length > 0
    ? `## ğŸ”— é–¢é€£TODO
${relatedTodos.map((t) => `- \`${t.file}:${t.line}\` - ${t.text}`).join('\n')}`
    : ''
}

## âœ… å®Œäº†æ¡ä»¶
- [ ] TODO ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤ã¾ãŸã¯å®Ÿè£…å®Œäº†
- [ ] é–¢é€£ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œç¢ºèª
- [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†

---
*ğŸ¤– Generated by TODO Management System*`

  return body
}

/**
 * TODOç”¨ã®Issueã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
 */
function generateIssueTitle(todo) {
  // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ©Ÿèƒ½ã‚’æ¨æ¸¬
  const fileName = path.basename(todo.file, path.extname(todo.file))
  const dirName = path.basename(path.dirname(todo.file))

  // çŸ­ç¸®ã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
  let title = todo.text
  if (title.length > 60) {
    title = title.substring(0, 57) + '...'
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’è¿½åŠ 
  const location = dirName !== '.' ? `${dirName}/${fileName}` : fileName

  return `TODO: ${title} (${location})`
}

/**
 * é–¢é€£TODOã‚’æ¤œç´¢
 */
function findRelatedTodos(targetTodo, allTodos) {
  const related = []
  const targetFile = targetTodo.file
  const targetDir = path.dirname(targetFile)

  for (const todo of allTodos) {
    if (todo === targetTodo) continue

    // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®TODO
    if (todo.file === targetFile) {
      related.push(todo)
      continue
    }

    // åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®TODO
    if (path.dirname(todo.file) === targetDir) {
      related.push(todo)
      continue
    }

    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒé¡ä¼¼ã™ã‚‹TODO
    const targetWords = targetTodo.text.toLowerCase().split(' ')
    const todoWords = todo.text.toLowerCase().split(' ')
    const commonWords = targetWords.filter((word) => todoWords.includes(word) && word.length > 3)

    if (commonWords.length >= 2) {
      related.push(todo)
    }
  }

  return related.slice(0, 5) // æœ€å¤§5å€‹
}

/**
 * GitHub CLI ã§Issueã‚’ä½œæˆ
 */
async function createGitHubIssue(todo, allTodos) {
  try {
    const title = generateIssueTitle(todo)
    const relatedTodos = findRelatedTodos(todo, allTodos)
    const body = generateIssueBody(todo, relatedTodos)
    const priority = analyzeTodoPriority(todo)
    const size = estimateTodoSize(todo)
    const categories = categorizeTodo(todo)

    // ãƒ©ãƒ™ãƒ«ã‚’æ§‹ç¯‰
    const labels = [priority, size, ...categories, 'todo-generated'].join(',')

    console.log(`${colors.blue}ğŸ“ Issueä½œæˆä¸­: ${colors.reset}${title}`)

    // GitHub CLI ã§Issueä½œæˆ
    const result = execSync(`gh issue create --title "${title}" --body "${body}" --label "${labels}"`, {
      encoding: 'utf8',
      cwd: process.cwd(),
    })

    const issueUrl = result.trim()
    const issueNumber = issueUrl.split('/').pop()

    console.log(`${colors.green}âœ… Issue #${issueNumber} ä½œæˆå®Œäº†: ${colors.reset}${issueUrl}`)

    return {
      number: issueNumber,
      url: issueUrl,
      todo: todo,
    }
  } catch (error) {
    console.error(`${colors.red}âŒ Issueä½œæˆã‚¨ãƒ©ãƒ¼: ${colors.reset}${error.message}`)
    return null
  }
}

/**
 * TODOã‚³ãƒ¡ãƒ³ãƒˆã«Issueç•ªå·ã‚’è¿½åŠ 
 */
function linkTodoToIssue(todo, issueNumber) {
  try {
    const filePath = todo.file
    const content = fs.readFileSync(filePath, 'utf8')
    const lines = content.split('\n')

    // è©²å½“è¡Œã‚’æ¢ã—ã¦Issueç•ªå·ã‚’è¿½åŠ 
    if (lines[todo.line - 1]) {
      const originalLine = lines[todo.line - 1]

      // æ—¢ã«Issueç•ªå·ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      if (originalLine.includes('#') && /\#\d+/.test(originalLine)) {
        console.log(`${colors.yellow}âš ï¸  ${filePath}:${todo.line} ã¯æ—¢ã«Issueç•ªå·ãŒå«ã¾ã‚Œã¦ã„ã¾ã™${colors.reset}`)
        return false
      }

      // Issueç•ªå·ã‚’è¿½åŠ 
      const updatedLine = originalLine.replace(new RegExp(`(${todo.type})(.*)$`), `$1$2 #${issueNumber}`)

      lines[todo.line - 1] = updatedLine
      fs.writeFileSync(filePath, lines.join('\n'))

      console.log(`${colors.green}ğŸ”— ${filePath}:${todo.line} ã«Issue #${issueNumber} ã‚’ãƒªãƒ³ã‚¯${colors.reset}`)
      return true
    }
  } catch (error) {
    console.error(`${colors.red}âŒ ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${colors.reset}${error.message}`)
    return false
  }
}

/**
 * ã™ã¹ã¦ã®TODOã‚’Issueã«å¤‰æ›
 */
async function convertAllTodosToIssues(options = {}) {
  console.log(`${colors.bold}${colors.blue}ğŸš€ TODO â†’ Issues è‡ªå‹•å¤‰æ›é–‹å§‹${colors.reset}`)

  // TODOè§£æ
  const allFiles = []
  const srcDir = path.join(process.cwd(), 'src')
  const scriptsDir = path.join(process.cwd(), 'scripts')
  const eslintDir = path.join(process.cwd(), '.eslint')

  function scanDirectory(dir) {
    if (!fs.existsSync(dir)) return

    const items = fs.readdirSync(dir)
    for (const item of items) {
      const fullPath = path.join(dir, item)
      const stat = fs.statSync(fullPath)

      if (stat.isDirectory() && !item.startsWith('.') && item !== 'node_modules') {
        scanDirectory(fullPath)
      } else if (stat.isFile() && /\.(js|ts|tsx|jsx)$/.test(item)) {
        allFiles.push(fullPath)
      }
    }
  }

  scanDirectory(srcDir)
  scanDirectory(scriptsDir)
  scanDirectory(eslintDir)

  // å…¨TODOã‚’åé›†
  const allTodos = []
  for (const file of allFiles) {
    const todos = analyzeTodosInFile(file)
    allTodos.push(...todos)
  }

  console.log(`${colors.cyan}ğŸ“Š ${allTodos.length}å€‹ã®TODOã‚’ç™ºè¦‹${colors.reset}`)

  if (allTodos.length === 0) {
    console.log(`${colors.yellow}â„¹ï¸  å¤‰æ›å¯¾è±¡ã®TODOãŒã‚ã‚Šã¾ã›ã‚“${colors.reset}`)
    return
  }

  // å„ªå…ˆåº¦åˆ¥ã«åˆ†é¡
  const byPriority = {}
  for (const todo of allTodos) {
    const priority = analyzeTodoPriority(todo)
    if (!byPriority[priority]) byPriority[priority] = []
    byPriority[priority].push(todo)
  }

  console.log(`${colors.bold}ğŸ“‹ å„ªå…ˆåº¦åˆ¥åˆ†é¡:${colors.reset}`)
  for (const [priority, todos] of Object.entries(byPriority)) {
    console.log(`  ${priority}: ${todos.length}å€‹`)
  }

  // ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
  if (!options.force) {
    console.log(
      `${colors.yellow}âš ï¸  ${allTodos.length}å€‹ã®TODOã‚’GitHub Issueã«å¤‰æ›ã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N)${colors.reset}`
    )
    // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ readline ã‚’ä½¿ç”¨
    console.log(`${colors.gray}--force ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—ã§ãã¾ã™${colors.reset}`)
    if (!options.dryRun) {
      console.log(`${colors.yellow}â¹ï¸  ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­ï¼ˆå®Ÿéš›ã®Issueä½œæˆã¯è¡Œã„ã¾ã›ã‚“ï¼‰${colors.reset}`)
      return
    }
  }

  // Issuesä½œæˆ
  const createdIssues = []
  let successCount = 0
  let errorCount = 0

  // å„ªå…ˆåº¦é †ã§å‡¦ç†
  const priorityOrder = ['P0-urgent', 'P1-high', 'P2-medium', 'P3-low']

  for (const priority of priorityOrder) {
    if (!byPriority[priority]) continue

    console.log(`\n${colors.bold}ğŸ¯ ${priority} TODOã‚’å‡¦ç†ä¸­...${colors.reset}`)

    for (const todo of byPriority[priority]) {
      if (options.dryRun) {
        console.log(`${colors.gray}[DRY-RUN] ${generateIssueTitle(todo)}${colors.reset}`)
        continue
      }

      const issue = await createGitHubIssue(todo, allTodos)
      if (issue) {
        createdIssues.push(issue)

        // TODOã‚³ãƒ¡ãƒ³ãƒˆã«Issueç•ªå·ã‚’ãƒªãƒ³ã‚¯
        if (options.linkTodos) {
          linkTodoToIssue(todo, issue.number)
        }

        successCount++
      } else {
        errorCount++
      }

      // APIåˆ¶é™å¯¾ç­–ã§å°‘ã—å¾…æ©Ÿ
      await new Promise((resolve) => setTimeout(resolve, 500))
    }
  }

  // çµæœã‚µãƒãƒªãƒ¼
  console.log(`\n${colors.bold}${colors.green}âœ… å¤‰æ›å®Œäº†${colors.reset}`)
  console.log(`${colors.green}æˆåŠŸ: ${successCount}ä»¶${colors.reset}`)
  if (errorCount > 0) {
    console.log(`${colors.red}ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶${colors.reset}`)
  }

  // ä½œæˆã•ã‚ŒãŸIssuesã®æ¦‚è¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  if (createdIssues.length > 0) {
    const reportPath = path.join(process.cwd(), '.eslint', 'reports', 'TODO_ISSUES_REPORT.md')
    generateIssuesReport(createdIssues, reportPath)
    console.log(`${colors.blue}ğŸ“‹ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ: ${reportPath}${colors.reset}`)
  }
}

/**
 * ä½œæˆã•ã‚ŒãŸIssuesã®ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
 */
function generateIssuesReport(issues, outputPath) {
  const report = `# ğŸ“‹ TODO â†’ Issues å¤‰æ›ãƒ¬ãƒãƒ¼ãƒˆ

## ğŸ“Š æ¦‚è¦
- **ä½œæˆæ—¥æ™‚**: ${new Date().toISOString()}
- **ä½œæˆIssuesæ•°**: ${issues.length}

## ğŸ“ ä½œæˆã•ã‚ŒãŸIssues

${issues
  .map(
    (issue) => `### Issue #${issue.number}
- **ã‚¿ã‚¤ãƒˆãƒ«**: ${generateIssueTitle(issue.todo)}
- **URL**: ${issue.url}
- **ãƒ•ã‚¡ã‚¤ãƒ«**: \`${issue.todo.file}:${issue.todo.line}\`
- **å†…å®¹**: ${issue.todo.text}
- **å„ªå…ˆåº¦**: ${analyzeTodoPriority(issue.todo)}
- **è¦æ¨¡**: ${estimateTodoSize(issue.todo)}

`
  )
  .join('\n')}

---
*ğŸ¤– Generated by TODO Management System*
`

  fs.writeFileSync(outputPath, report)
}

// ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°å‡¦ç†
function parseArgs() {
  const args = process.argv.slice(2)
  const options = {
    force: false,
    dryRun: false,
    linkTodos: false,
    help: false,
  }

  for (let i = 0; i < args.length; i++) {
    switch (args[i]) {
      case '--force':
      case '-f':
        options.force = true
        break
      case '--dry-run':
      case '-d':
        options.dryRun = true
        break
      case '--link':
      case '-l':
        options.linkTodos = true
        break
      case '--help':
      case '-h':
        options.help = true
        break
    }
  }

  return options
}

function showHelp() {
  console.log(`
${colors.bold}TODO â†’ GitHub Issues è‡ªå‹•å¤‰æ›ã‚·ã‚¹ãƒ†ãƒ ${colors.reset}

${colors.bold}ä½¿ç”¨æ–¹æ³•:${colors.reset}
  node scripts/todo-to-issues.js [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]

${colors.bold}ã‚ªãƒ—ã‚·ãƒ§ãƒ³:${colors.reset}
  -f, --force     ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
  -d, --dry-run   å®Ÿéš›ã®Issueä½œæˆã‚’è¡Œã‚ãšã«å®Ÿè¡Œ
  -l, --link      TODOã‚³ãƒ¡ãƒ³ãƒˆã«Issueç•ªå·ã‚’ãƒªãƒ³ã‚¯
  -h, --help      ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

${colors.bold}ä¾‹:${colors.reset}
  ${colors.gray}# ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã§ç¢ºèª${colors.reset}
  npm run todo:to-issues -- --dry-run
  
  ${colors.gray}# å®Ÿéš›ã«Issueä½œæˆï¼ˆTODOã«ãƒªãƒ³ã‚¯è¿½åŠ ï¼‰${colors.reset}
  npm run todo:to-issues -- --force --link

${colors.bold}å‰ææ¡ä»¶:${colors.reset}
  - GitHub CLI (gh) ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
  - èªè¨¼æ¸ˆã¿ã®GitHubãƒªãƒã‚¸ãƒˆãƒª
`)
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
async function main() {
  const options = parseArgs()

  if (options.help) {
    showHelp()
    return
  }

  try {
    await convertAllTodosToIssues(options)
  } catch (error) {
    console.error(`${colors.red}âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}${colors.reset}`)
    process.exit(1)
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦å®Ÿè¡Œã•ã‚ŒãŸå ´åˆ
if (require.main === module) {
  main()
}

module.exports = {
  convertAllTodosToIssues,
  analyzeTodoPriority,
  estimateTodoSize,
  categorizeTodo,
  generateIssueBody,
  generateIssueTitle,
}
