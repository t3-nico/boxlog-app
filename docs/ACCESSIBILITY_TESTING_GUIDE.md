# アクセシビリティテストガイド

## 概要

BoxLogカレンダーアプリのWCAG 2.1 AAA準拠アクセシビリティテストガイドです。

## テスト環境

### 必要なツール

1. **axe DevTools** - ブラウザ拡張機能
2. **NVDA** - スクリーンリーダー（Windows）
3. **キーボードのみ操作** - マウス・タッチ無効化

### ブラウザ対応

- Chrome（推奨）
- Firefox
- Edge
- Safari（macOS VoiceOver対応）

## 自動テスト（axe DevTools）

### セットアップ

1. Chrome Web Storeから「axe DevTools」をインストール
2. 開発者ツールを開く（F12）
3. 「axe DevTools」タブを選択

### テスト手順

```bash
# 1. カレンダーページを開く
npm run dev
# http://localhost:3000/calendar にアクセス

# 2. axe DevToolsでスキャン実行
# - "Scan all of my page" ボタンをクリック
# - 結果を確認（Violations: 0を目指す）
```

### 確認ポイント

- **Violations: 0** であること
- **Needs Review** 項目の手動確認
- **Passes** の件数確認

## キーボード操作テスト

### 基本操作の確認

| 操作 | キー | 期待される動作 |
|------|------|----------------|
| フォーカス移動 | Tab / Shift+Tab | 論理的な順序でフォーカス移動 |
| カレンダーフォーカス | Tab | カレンダーグリッドにフォーカス |
| 日付移動 | ↑↓←→ | 日付・時間・イベント間の移動 |
| 週移動 | Shift + ←→ | 週単位での移動 |
| ページ移動 | PageUp/PageDown | 週単位での移動 |
| 時間移動（先頭） | Home | 最初の時間スロット（00:00） |
| 時間移動（末尾） | End | 最後の時間スロット（23:45） |
| イベント作成 | Enter | 選択位置でイベント作成 |
| イベント編集 | Enter（選択時） | 選択イベントの編集 |
| イベント削除 | Delete / Backspace | 選択イベントの削除 |
| 操作キャンセル | Escape | 現在の操作をキャンセル |
| ヘルプ表示 | F1 | キーボードヘルプの読み上げ |
| 詳細情報 | Space | 選択イベントの詳細読み上げ |

### テスト手順

1. **マウスを無効化**
   ```javascript
   // ブラウザコンソールで実行
   document.body.style.pointerEvents = 'none'
   ```

2. **キーボードナビゲーション確認**
   - すべての機能がキーボードでアクセス可能
   - フォーカス表示が明確
   - フォーカストラップが適切に動作

3. **操作フロー確認**
   ```
   Tab → カレンダーフォーカス
   ↑↓←→ → 日付・時間移動
   Enter → イベント作成
   Tab → フォーム内移動
   Enter → 保存
   Escape → キャンセル
   ```

## スクリーンリーダーテスト（NVDA）

### NVDAセットアップ

1. [NVDA公式サイト](https://www.nvaccess.org/)からダウンロード
2. インストール・起動
3. 音声出力の確認

### テスト手順

#### 1. ページ読み込み時

```
期待される読み上げ:
"BoxLog カレンダー ランドマーク メイン"
"週間カレンダー グリッド"
"カレンダーグリッド。矢印キーで日付と時間を移動..."
```

#### 2. カレンダーナビゲーション

```bash
# フォーカス移動
Tab → "週間カレンダー グリッド"

# 日付移動
→ → "2024年7月16日火曜日 9時0分。空き時間。選択中"
↓ → "2024年7月16日火曜日 9時15分。空き時間"
```

#### 3. イベント操作

```bash
# イベント選択時
Tab → "会議 9時0分から10時0分まで。場所: 会議室A"

# イベント作成
Enter → "9時0分に新しいイベントを作成します"

# イベント削除
Delete → "会議を削除します"
```

#### 4. 設定変更の読み上げ

```bash
# ハイコントラスト有効化
"ハイコントラストモードを有効にしました"

# テーマ変更
"黒地に白文字テーマに変更しました"
```

### NVDAコマンド

| コマンド | キー | 説明 |
|----------|------|------|
| 読み上げ停止 | Ctrl | 現在の読み上げを停止 |
| 全体読み上げ | NVDA+↓ | ページ全体を読み上げ |
| フォーカス読み上げ | NVDA+Tab | 現在のフォーカス要素 |
| タイトル読み上げ | NVDA+T | ページタイトル |
| 見出し移動 | H | 次の見出しに移動 |
| ランドマーク移動 | D | 次のランドマークに移動 |
| リスト移動 | L | 次のリストに移動 |
| ボタン移動 | B | 次のボタンに移動 |

## ハイコントラストモードテスト

### 自動切り替えテスト

1. **システム設定でハイコントラスト有効化**
   - Windows: 設定 > 簡単操作 > ハイコントラスト
   - 自動的にアプリでも有効化されること

2. **手動切り替えテスト**
   - アクセシビリティ設定から切り替え
   - 各テーマの表示確認

### テーマ別確認

| テーマ | 背景色 | 文字色 | コントラスト比 |
|--------|--------|--------|----------------|
| 標準 | #ffffff | #000000 | 21:1 |
| 黒地白文字 | #000000 | #ffffff | 21:1 |
| 白地黒文字 | #ffffff | #000000 | 21:1 |
| 黄地青文字 | #ffff00 | #000080 | 8.5:1 |
| 黒地黄文字 | #000000 | #ffff00 | 19.6:1 |

### 確認ポイント

- フォーカス表示の明確さ
- テキストの読みやすさ
- ボタン・リンクの識別可能性
- エラーメッセージの視認性

## フォーカストラップテスト

### モーダル・ダイアログ

1. **イベント作成モーダル**
   ```bash
   Enter → モーダル開く
   Tab → フォーム内要素に順次フォーカス
   Shift+Tab → 逆順フォーカス
   Tab（最後の要素から） → 最初の要素に戻る
   Escape → モーダル閉じる + フォーカス復帰
   ```

2. **設定ダイアログ**
   ```bash
   # 同様のテストを実行
   # フォーカスが外部に漏れないこと
   ```

### 外部クリック・Escapeテスト

- モーダル外クリックで閉じること
- Escapeキーで閉じること
- フォーカスが元の位置に戻ること

## パフォーマンステスト

### 大量データでの動作確認

```bash
# 10,000イベントでのテスト
# 応答時間が100ms以内であること
# スクリーンリーダーの読み上げが途切れないこと
```

### 低スペック環境

- CPU使用率の監視
- メモリ使用量の確認
- バッテリー消費の測定

## テストチェックリスト

### 自動テスト
- [ ] axe DevTools エラー 0件
- [ ] ESLint a11y ルール通過
- [ ] Lighthouse アクセシビリティスコア 100点

### キーボードテスト
- [ ] すべての機能がキーボードアクセス可能
- [ ] フォーカス順序が論理的
- [ ] フォーカス表示が明確
- [ ] キーボードトラップなし

### スクリーンリーダーテスト
- [ ] ページ構造が適切に読み上げられる
- [ ] ナビゲーション操作の音声フィードバック
- [ ] フォーム入力時の適切なガイダンス
- [ ] エラーメッセージの読み上げ
- [ ] ライブリージョンでの状態変更通知

### ハイコントラストテスト
- [ ] 各テーマでのWCAG AAA準拠
- [ ] システム設定との連携
- [ ] フォーカス表示の強化
- [ ] 色に依存しない情報伝達

### フォーカストラップテスト
- [ ] モーダル内でのフォーカス循環
- [ ] 外部クリックでの適切な終了
- [ ] Escapeキーでの適切な終了
- [ ] フォーカス復帰の正確性

## 問題発生時の対応

### よくある問題

1. **axe違反が残る場合**
   - HTML構造の見直し
   - ARIA属性の追加・修正
   - セマンティックな要素の使用

2. **NVDA読み上げ不具合**
   - aria-label の追加
   - aria-describedby の関連付け
   - ライブリージョンの設定確認

3. **キーボード操作不能**
   - tabindex の確認
   - フォーカス管理ロジックの見直し
   - イベントハンドラーの修正

### デバッグツール

```javascript
// フォーカス状況の確認
console.log('Current focus:', document.activeElement)

// ARIA属性の確認
const element = document.activeElement
console.log('ARIA attributes:', {
  label: element.getAttribute('aria-label'),
  describedby: element.getAttribute('aria-describedby'),
  role: element.getAttribute('role')
})

// アクセシビリティ監査実行
import { runAccessibilityAudit } from './AccessibilityTestUtils'
runAccessibilityAudit().then(console.log)
```

## 継続的な品質確保

### CI/CD統合

```yaml
# .github/workflows/accessibility.yml
- name: Accessibility Test
  run: |
    npm run test:a11y
    npm run axe:ci
```

### 定期監視

- 毎月のアクセシビリティ監査
- ユーザーフィードバックの収集
- 新機能のアクセシビリティレビュー

---

このガイドに従ってテストを実行し、すべての項目をクリアすることで、WCAG 2.1 AAA準拠のアクセシブルなカレンダーアプリケーションが実現されます。