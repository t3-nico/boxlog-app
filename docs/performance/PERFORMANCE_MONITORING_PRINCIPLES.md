# パフォーマンス監視の原則

> 速度・安定性の数字をどう見て、どう行動するか

## 大前提（最重要）

**平均は見ない。p95（必要に応じてp99）だけを見る。**

理由：
- ユーザー体験は「一部の遅い人」で評価される
- BtoCでは「たまに遅い」が致命傷になる
- 平均値は"問題を隠す"

---

## 1. 速度（Performance）の考え方

### 速度 = 「体感」

速さは技術指標ではなく、**体験指標**。

### 見るレイヤーは3つ

| レイヤー | 意味 | 確認場所 |
|---------|------|---------|
| フロント | 体感そのもの | Sentry Web Vitals |
| API | 処理の速さ | Sentry Transactions |
| DB | 基礎体力 | Sentry Spans / Supabase |

### フロントの速度指標（最優先）

ユーザーが「遅い」と感じる正体。

| 指標 | 意味 | 見る値 | 基準 |
|------|------|--------|------|
| **LCP** | 画面が表示されたと感じるまで | p95 | ≤ 2.5s |
| **INP** | 操作に反応するまで | p95 | ≤ 200ms |
| **CLS** | レイアウトのズレ | p95 | < 0.1 |

考え方：
- p95が悪化 = ユーザー体感が悪化
- p75が良くても p95 が悪ければ「遅い」

### APIの速度指標

フロントが待たされる原因。

| 指標 | 目安 |
|------|------|
| API latency p95 | ≤ 300ms |
| 初期表示API p95 | 最優先で見る |

考え方：
- ログイン後に必ず叩くAPIは"生命線"
- 一部APIだけ遅いなら、そこだけ直す

### DBの速度指標

全体を引きずり落とす土台。

| 指標 | 目安 |
|------|------|
| クエリ実行時間 p95 | ≤ 100ms |

考え方：
- DBが遅い = APIも必ず遅くなる
- ユーザー増加で悪化しやすい

---

## 2. 安定性（Reliability）の考え方

### 安定性 = 「不安にさせない」

落ちないことより「**失敗しても安心できること**」が重要。

### 見るべき安定性指標

| 指標 | 見る値 |
|------|--------|
| エラー率 | 主要導線のみ（< 0.1%目安） |
| タイムアウト率 | p95/p99 |
| 失敗後の再試行成功率 | トレンド |
| 同一エラーの再発率 | 月次 |

考え方：
- 全体エラー率は見ない
- ログイン後・保存・課金など"致命導線"だけを見る

---

## 3. p95 / p99 の役割分担

| 指標 | 役割 |
|------|------|
| **p95** | 体感品質・改善対象 |
| **p99** | 障害・事故の早期検知 |
| 平均 | 参考値（判断には使わない） |

---

## 4. 数字は「合否」ではなく「行動トリガー」

速度・安定性は Pass / Fail にしない。

### 正しい扱い

- p95が悪化 → **改善Issueを必ず1つ作る**
- 良化 → 正解パターンとして残す

### 間違った扱い

- ❌ 数字だけ下げて満足
- ❌ 体感が変わらない最適化
- ❌ 最大値（p100）を追いかける

---

## 5. 最小SLO（目標値）

まずはこれだけで十分。

| 項目 | 目標 |
|------|------|
| ログイン後トップ LCP p95 | ≤ 3.0s |
| 主要API latency p95 | ≤ 300ms |
| 主要導線エラー率 | < 0.1%（増加NG） |
| p95悪化 | 改善Issue必須 |

---

## 6. 監視ツールの使い分け

| ツール | 役割 | 見るもの |
|--------|------|---------|
| **Sentry** | エラー・パフォーマンス | Issues, Web Vitals, Transactions |
| **Lighthouse CI** | リリース前チェック | Core Web Vitals |
| **PostHog** | ユーザー行動分析 | コンバージョン、離脱 |

---

## まとめ

1. **平均は見ない**
2. **p95がすべて**
3. **速度＝体感、安定性＝安心感**
4. **数字は評価ではなく行動の引き金**
5. **悪化したら必ず直す、良くなったら資産化**

---

**最終更新**: 2026-01-13
