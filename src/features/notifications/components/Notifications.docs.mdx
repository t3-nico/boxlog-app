import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Draft/Notifications/Docs" />

# Notifications

プラン変更、リマインダー、システムメッセージをユーザーに通知するシステム。

---

## 要件

### 通知タイプ

| タイプ | 説明 | アイコン |
|-------|------|---------|
| `reminder` | プラン開始前リマインダー | bell |
| `plan_created` | プラン作成 | calendar |
| `plan_updated` | プラン更新 | calendar |
| `plan_deleted` | プラン削除 | trash |
| `plan_completed` | プラン完了 | check |
| `trash_warning` | ゴミ箱自動削除警告 | alert |
| `system` | システム通知 | info |

### 優先度

| 優先度 | 表示 |
|-------|------|
| `urgent` | 緊急（赤） |
| `high` | 高（オレンジ） |
| `medium` | 中（青） |
| `low` | 低（グレー） |

---

## DB スキーマ

### notifications テーブル

| カラム | 型 | 説明 |
|-------|-----|------|
| `id` | UUID | PK |
| `user_id` | UUID | FK → auth.users |
| `type` | TEXT | 通知タイプ（CHECK制約） |
| `priority` | TEXT | 優先度（default: medium） |
| `title` | TEXT | 通知タイトル |
| `message` | TEXT | 通知本文（nullable） |
| `related_plan_id` | UUID | 関連プラン（nullable） |
| `action_url` | TEXT | クリック時遷移先 |
| `icon` | TEXT | 表示アイコン |
| `data` | JSONB | 拡張用データ |
| `is_read` | BOOLEAN | 既読状態 |
| `read_at` | TIMESTAMPTZ | 既読日時 |
| `expires_at` | TIMESTAMPTZ | 有効期限 |

- **RLS**: `auth.uid() = user_id` で自分の通知のみアクセス
- **インデックス**: `user_id`, `(user_id, is_read)`, `created_at DESC`
- **自動削除**: 既読30日後にCron Jobで削除

### notification_preferences テーブル

ユーザーごとの通知設定（ブラウザ通知、メール通知、リマインダーデフォルト分数等）。

---

## データフロー

```
[ユーザー操作（プラン作成/更新/削除）]
       ↓
[通知生成関数 → Supabase INSERT]
       ↓
[Realtime Subscription]
       ↓
[tRPC + TanStack Query キャッシュ更新]
       ↓
[UI更新: NotificationDropdown + NotificationItem]
```

---

## コンポーネント構成

```
src/features/notifications/
├── components/
│   ├── NotificationDropdown.tsx      ドロップダウンメニュー
│   ├── NotificationItem.tsx          通知アイテム
│   └── Notifications.docs.mdx       ドキュメント
├── hooks/
│   ├── useNotifications.ts           ブラウザ通知管理
│   └── useNotificationPreferences.ts 通知設定・配信判定
├── utils/
│   └── notification-helpers.ts       ヘルパー関数
├── lib/
│   └── transformers.ts               Entity → Notification変換
├── types.ts                          型定義（@/schemas/notifications から re-export）
└── index.ts                          公開API
```

---

## tRPC ルーター

| プロシージャ | タイプ | 説明 |
|-------------|-------|------|
| `notifications.list` | query | 通知一覧取得 |
| `notifications.markAsRead` | mutation | 個別既読化 |
| `notifications.markAllAsRead` | mutation | 一括既読化 |
| `notifications.delete` | mutation | 通知削除 |

---

## 通知生成トリガー

| トリガー | 実行タイミング | 優先度 |
|---------|--------------|--------|
| リマインダー | Cron Job（1分ごと） | high |
| プラン変更 | クライアント操作時 | medium |
| ゴミ箱警告 | Cron Job（1日1回） | urgent |

---

## パフォーマンス

- ページネーション: 50件ずつ取得
- キャッシュ: TanStack Query
- 自動削除: 既読30日後

---

## セキュリティ

- RLS有効化: 自分の通知のみアクセス
- XSS対策: messageフィールドのサニタイズ
- レート制限: 通知作成は1分間に10件まで

---

**最終更新**: 2026-02-19
