import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Draft/Notifications/Docs" />

# Notifications

リマインダー通知をユーザーに配信するシステム。個人向けアプリのため、自分の操作に対するイベント通知は不要（Google Calendarと同じ思想）。

---

## 通知タイプ

| タイプ | 説明 | アイコン |
|-------|------|---------|
| `reminder` | プラン開始前リマインダー | Bell |
| `overdue` | 期限超過通知（将来追加） | AlertTriangle |

---

## DB スキーマ

### notifications テーブル

| カラム | 型 | 説明 |
|-------|-----|------|
| `id` | UUID | PK |
| `user_id` | UUID | FK → auth.users |
| `type` | TEXT | 通知タイプ: reminder \| overdue |
| `plan_id` | UUID | 対象プランID（FK → plans） |
| `is_read` | BOOLEAN | 既読状態 |
| `read_at` | TIMESTAMPTZ | 既読日時 |
| `created_at` | TIMESTAMPTZ | 作成日時 |

- **RLS**: `auth.uid() = user_id` で自分の通知のみアクセス
- **インデックス**: `user_id`, `(user_id, is_read)`, `plan_id`, `created_at DESC`

### notification_preferences テーブル

| カラム | 型 | 説明 |
|-------|-----|------|
| `enable_browser_notifications` | BOOLEAN | ブラウザ通知ON/OFF |
| `default_reminder_minutes` | INTEGER | デフォルトリマインダー時間（分） |

---

## データフロー

```
[Cron Job: check-reminders（1分ごと）]
       ↓
[Edge Function → Supabase INSERT]
       ↓
[Realtime Subscription]
       ↓
[tRPC + TanStack Query キャッシュ更新]
       ↓
[UI更新: NotificationDropdown + NotificationItem]
```

---

## コンポーネント構成

```
src/features/notifications/
├── components/
│   ├── NotificationDropdown.tsx      ドロップダウンメニュー
│   ├── NotificationItem.tsx          通知アイテム
│   └── Notifications.docs.mdx       ドキュメント
├── hooks/
│   ├── useNotifications.ts           ブラウザ通知管理
│   ├── useNotificationPreferences.ts ブラウザ通知ON/OFF設定
│   ├── useNotificationRealtime.ts    Realtime購読
│   └── useNotificationsData.ts       tRPCデータ取得・楽観的更新
├── utils/
│   └── notification-helpers.ts       ヘルパー関数
├── lib/
│   └── transformers.ts               Entity → Notification変換
├── types.ts                          型定義（@/schemas/notifications から re-export）
└── index.ts                          公開API
```

---

## tRPC ルーター

| プロシージャ | タイプ | 説明 |
|-------------|-------|------|
| `notifications.list` | query | 通知一覧取得（plan titleをJOIN） |
| `notifications.markAsRead` | mutation | 個別既読化 |
| `notifications.markAllAsRead` | mutation | 一括既読化 |
| `notifications.delete` | mutation | 通知削除 |
| `notificationPreferences.get` | query | 設定取得 |
| `notificationPreferences.updateBrowserNotifications` | mutation | ブラウザ通知ON/OFF |
| `notificationPreferences.updateDefaultReminderMinutes` | mutation | リマインダー時間更新 |

---

## パフォーマンス

- ページネーション: 50件ずつ取得
- キャッシュ: TanStack Query
- 自動削除: 既読30日後

---

## セキュリティ

- RLS有効化: 自分の通知のみアクセス
- レート制限: 通知作成は1分間に10件まで

---

**最終更新**: 2026-02-25
