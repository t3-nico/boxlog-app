import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Features/Tags/Docs" />

# Tags

プラン・レコードを分類するタグシステム。親子2階層、ドラッグ並べ替え、マージ、カラーパレットをサポート。

---

## 概要

| 項目 | 値 |
|------|-----|
| 階層 | 2レベルまで（親 → 子） |
| カラー | 50+ カラーパレット |
| 紐付け | Plans / Records と多対多 |
| 並べ替え | dnd-kit によるドラッグ&ドロップ |
| マージ | ソースタグ → ターゲットタグに統合 |

---

## コンポーネント構成

```
TagBadge                        タグバッジ表示
TagSelectCombobox               階層対応タグ選択（親/子展開）
TagSortableTree                 dnd-kit ドラッグ並べ替えツリー
├── SortableTagTreeItem         ソート可能ツリーアイテム
└── TagTreeItem                 アイテム描画

TagCreateModal                  新規タグ作成（親選択対応）
TagMergeModal                   タグマージ（関連移動+削除）
TagRenameDialog                 リネーム
TagNoteDialog                   説明編集
GlobalTagCreateModal            グローバルモーダルラッパー
GlobalTagMergeModal             グローバルモーダルラッパー
```

---

## 状態管理

### Zustand Stores

| Store | 用途 | persist |
|-------|------|---------|
| `useTagStore` | メインタグ状態（CRUD操作） | Yes |
| `useTagCreateModalStore` | 作成モーダル状態 | No |
| `useTagMergeModalStore` | マージモーダル状態 | No |
| `useTagCacheStore` | mutation参照カウント、競合防止 | No |

---

## Hooks

### Query

| Hook | 用途 |
|------|------|
| `useTags()` | 全タグ取得（staleTime: 5min） |
| `useTag(id)` | 単一タグ取得 |
| `useTagsMap()` | タグ配列 → Map 変換（高速検索） |

### Mutation（全て楽観的更新付き）

| Hook | 用途 |
|------|------|
| `useCreateTag()` | タグ作成 |
| `useUpdateTag()` | タグ更新 |
| `useUpdateTagColor()` | カラーのみ更新 |
| `useDeleteTag()` | タグ削除 |
| `useMergeTag()` | タグマージ |
| `useRenameTag()` | リネーム |
| `useMoveTag()` | 親変更 |
| `useReorderTags()` | 一括並べ替え |

### その他

| Hook | 用途 |
|------|------|
| `useTagOperations()` | 一元化された CRUD ロジック |
| `useTagRealtime()` | Supabase Realtime 購読 |

---

## tRPC ルーター

| エンドポイント | タイプ | 説明 |
|-------------|-------|------|
| `tags.list` | query | 全タグ（フラット） |
| `tags.listHierarchy` | query | 階層構造 |
| `tags.getById` | query | 単一タグ |
| `tags.create` | mutation | 作成 |
| `tags.update` | mutation | 更新 |
| `tags.merge` | mutation | マージ |
| `tags.delete` | mutation | 削除 |
| `tags.reorder` | mutation | 並べ替え |
| `tags.getStats` | query | 利用統計 |

---

## 階層モデル

```
Parent Tag (level=0, depth=1)
├── Child Tag A (level=1, depth=2, parent_id=Parent)
├── Child Tag B (level=1, depth=2, parent_id=Parent)
└── Child Tag C (level=1, depth=2, parent_id=Parent)
```

- **最大深度**: 1レベル（DB トリガーで強制）
- **制約**: 子を持つタグは他のタグの子になれない
- **自動計算**: `level`, `depth`, `path` はトリガーで更新

---

## マージ操作

```
ソースタグ → ターゲットタグ
  1. ソースの plan_tags / record_tags をターゲットに移動
  2. ソースの子タグをターゲットの子に昇格
  3. ソースタグを削除
  ※ トランザクション内で実行
```

---

## DB スキーマ

### tags テーブル

| カラム | 型 | 説明 |
|-------|-----|------|
| `id` | UUID | PK |
| `user_id` | UUID | FK → auth.users |
| `name` | TEXT | タグ名 |
| `color` | TEXT | HEXカラー |
| `description` | TEXT | 説明 |
| `parent_id` | UUID | FK → tags（自己参照） |
| `sort_order` | INT | 並び順 |
| `level` | SMALLINT | 0=親, 1=子 |
| `is_active` | BOOLEAN | アクティブ状態 |

- **RLS**: `auth.uid() = user_id`
- **トリガー**: `check_tag_hierarchy()`, `enforce_tag_no_children_as_child`

### 関連テーブル

- `plan_tags`: Plans との多対多
- `record_tags`: Records との多対多

---

## カレンダーフィルター連携

`useCalendarFilterStore` と連携:
- `isTypeVisible()`: Plan / Record の表示切替
- `isPlanVisible()`: タグベースのフィルタリング
- 未タグアイテムの表示トグル

---

**最終更新**: 2026-02-17
