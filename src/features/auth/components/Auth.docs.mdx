import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Features/Auth/Docs" />

# Auth

Supabase Auth ベースの認証システム。OAuth、MFA、セッション監視をサポート。

---

## 認証フロー

```
ユーザーアクセス
├── 未認証 → AuthLayout（ログイン/サインアップフォーム）
│   ├── メール/パスワード認証
│   └── OAuth（Google, Apple, GitHub）
│       └── 認証成功 → セッション確立
├── MFAチェック
│   └── MFA有効 → MFA認証画面
└── 認証済み → ProtectedRoute → アプリ表示
    └── SessionMonitor → 非アクティブ監視
        └── タイムアウト → SessionTimeoutDialog
```

---

## コンポーネント構成

```
AuthLayout                      認証ページレイアウト
├── LoginForm                   メール/パスワード + OAuthボタン
├── SignupForm                  登録フォーム（メール確認付き）
└── PasswordResetForm           パスワードリセット

ProtectedRoute                  クライアント側ルート保護
AuthGuard                       認証ガードラッパー
AuthStoreInitializer            Server Component からストア初期化

SessionMonitorProvider          セッション監視プロバイダー
└── SessionTimeoutDialog        非アクティブ警告ダイアログ
```

---

## 状態管理

### useAuthStore

| State | 説明 |
|-------|------|
| `user` | Supabase User オブジェクト |
| `session` | セッション情報 |
| `loading` | 認証処理中 |
| `error` | エラー状態 |

| Action | 説明 |
|--------|------|
| `signIn(email, password)` | メール認証 |
| `signUp(email, password)` | 新規登録 |
| `signInWithOAuth(provider)` | OAuth認証 |
| `signOut()` | ログアウト |
| `resetPassword(email)` | パスワードリセット |
| `updatePassword(password)` | パスワード更新 |

devtools ミドルウェア付き、タイムアウト処理（5秒）。

---

## Hooks

| Hook | 用途 |
|------|------|
| `useAuth()` | ストアラッパー（user, session, 全アクション） |
| `useSessionMonitor()` | セッションタイムアウト監視 |

---

## セキュリティ

| 対策 | 説明 |
|------|------|
| OWASP準拠 | パスワードリセットエラーのマスキング |
| IPレートリミット | `ip-rate-limit.ts` |
| 監査ログ | `audit-log.ts`（認証イベント記録） |
| エラーサニタイズ | `sanitize-auth-error.ts` |

---

## OAuth プロバイダー

| プロバイダー | 設定 |
|------------|------|
| Google | `auth-config.ts` |
| Apple | `auth-config.ts` |
| GitHub | `auth-config.ts` |

---

## バリデーション

| スキーマ | バリデーション |
|---------|--------------|
| `loginSchema` | メール形式、パスワード必須 |
| `signupSchema` | メール形式、パスワード強度 |

Zod ベースのバリデーション。

---

**最終更新**: 2026-02-17
