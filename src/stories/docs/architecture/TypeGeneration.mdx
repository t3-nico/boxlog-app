import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Docs/Architecture/Type Generation" />

# Supabase 型自動生成

Supabase CLIを使用して、データベーススキーマからTypeScript型定義を自動生成する。

---

## コマンド

| コマンド | ソース | 用途 |
|----------|--------|------|
| `npm run types:generate` | Production DB | 本番スキーマから生成（推奨） |
| `npm run types:generate:staging` | Staging DB | ステージングスキーマから生成 |
| `npm run types:generate:local` | Local DB | ローカルから生成（`supabase start` 必要） |

全コマンドとも `src/types/supabase.ts` に出力。

---

## 使用タイミング

### 必須

- データベーススキーマを変更した後
- 新しいテーブルを追加した後
- カラムの型を変更した後

### 推奨

- 定期的（週1回程度）
- 本番環境のスキーマと同期を確認する

---

## ワークフロー

```bash
# 1. マイグレーション作成・適用
npm run migration:create add_new_table
# マイグレーションファイルを編集
supabase db push

# 2. 型を再生成
npm run types:generate

# 3. 型チェック
npm run typecheck

# 4. コミット
git add src/types/supabase.ts
git commit -m "chore(types): supabase型定義を更新"
```

---

## カスタム型

`src/types/supabase.ts` は自動生成ファイル。**直接編集禁止**。

カスタム型が必要な場合は別ファイルに定義:

```typescript
// src/types/custom.ts
import type { Database } from './supabase';

export type PlanRow = Database['public']['Tables']['plans']['Row'];
export type TagRow = Database['public']['Tables']['tags']['Row'];
```

---

## トラブルシューティング

| エラー | 対処 |
|--------|------|
| `project_id not found` | Supabase プロジェクトの存在を確認 |
| `connection refused` | ローカル: `supabase start` を実行 / リモート: ネットワーク確認 |
| 生成された型がおかしい | 最新のマイグレーションが適用されているか確認。`supabase db reset` でリセット |
