import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Docs/実装ガイド/パフォーマンス" />

# パフォーマンス監視の原則

> **平均は見ない。p95だけを見る。**

---

## なぜp95か

- ユーザー体験は「一部の遅い人」で評価される
- BtoCでは「たまに遅い」が致命傷
- 平均値は問題を隠す

| 指標 | 役割 |
|------|------|
| **p95** | 体感品質・改善対象 |
| **p99** | 障害・事故の早期検知 |
| 平均 | 参考値（判断には使わない） |

---

## 速度指標

### フロント（最優先）

ユーザーが「遅い」と感じる正体。

| 指標 | 意味 | 基準（p95） |
|------|------|------------|
| **LCP** | 画面が表示されたと感じるまで | ≤ 2.5s |
| **INP** | 操作に反応するまで | ≤ 200ms |
| **CLS** | レイアウトのズレ | < 0.1 |

### API

| 指標 | 基準（p95） |
|------|------------|
| API latency | ≤ 300ms |
| 初期表示API | 最優先で監視 |

### DB

| 指標 | 基準（p95） |
|------|------------|
| クエリ実行時間 | ≤ 100ms |

---

## 安定性指標

安定性 = 「失敗しても安心できること」

| 指標 | 基準 |
|------|------|
| 主要導線エラー率 | < 0.1% |
| タイムアウト率 | p95/p99で監視 |
| 同一エラーの再発率 | 月次チェック |

**注意**: 全体エラー率ではなく、ログイン後・保存・課金など"致命導線"だけを見る。

---

## 最小SLO（目標値）

| 項目 | 目標 |
|------|------|
| ログイン後トップ LCP p95 | ≤ 3.0s |
| 主要API latency p95 | ≤ 300ms |
| 主要導線エラー率 | < 0.1%（増加NG） |
| p95悪化時 | **改善Issue必須** |

---

## 行動ルール

数字は「合否」ではなく「行動トリガー」。

| 状況 | アクション |
|------|-----------|
| p95が悪化 | 改善Issueを必ず1つ作る |
| p95が良化 | 正解パターンとして記録 |

### やってはいけないこと

- 数字だけ下げて満足
- 体感が変わらない最適化
- 最大値（p100）を追いかける

---

## 監視ツールの使い分け

| ツール | 役割 | 見るもの |
|--------|------|---------|
| **Sentry** | エラー・パフォーマンス | Issues, Web Vitals, Transactions |
| **Lighthouse CI** | リリース前チェック | Core Web Vitals |
| **PostHog** | ユーザー行動分析 | コンバージョン、離脱 |

---

## React最適化クイックリファレンス

| パターン | 使うとき |
|---------|---------|
| `useMemo` | 高コストな計算 |
| `useCallback` | 子に渡すコールバック |
| `React.memo` | 重いコンポーネント |

**最適化が不要なケース**:
- 単純なコンポーネント（メモ化のオーバーヘッドの方が大きい）
- propsが毎回変わる場合
- 再レンダリングが問題になっていない場合

---

**最終更新**: 2026-02-12 | **バージョン**: v1.0
