import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Docs/実装ガイド/バンドル監視" />

# バンドルサイズ監視

BoxLogアプリケーションのバンドルサイズ監視とパフォーマンス最適化のリファレンス。

---

## バンドルサイズ制限

### JavaScript

| 項目 | 制限 |
|------|------|
| メインJS合計 | 800KB |
| 初期読み込みJS | 500KB |
| 個別チャンク | 250KB |

### CSS

| 項目 | 制限 |
|------|------|
| CSS合計 | 150KB |
| 初期読み込みCSS | 100KB |

### 総合

| 項目 | 制限 |
|------|------|
| 全バンドル合計 | 1MB |
| 警告しきい値 | 80%（制限の80%に到達で警告） |

---

## コマンド

### バンドルサイズチェック

```bash
npm run bundle:check           # 基本的なバンドルサイズチェック
npm run bundle:check:verbose   # 詳細出力でのチェック
npm run bundle:analyze         # バンドル分析レポート生成
npm run bundle:monitor         # チェック + 分析の組み合わせ
```

### ESLint バンドル最適化

```bash
npm run lint:bundle            # バンドル最適化ルールのチェック
npm run lint:bundle:strict     # 厳格モード（エラーレベル）
npm run lint:imports           # インポート順序チェック
```

---

## 監視の仕組み

### 自動チェック

- **PR作成時**: 自動的にバンドルサイズをチェック
- **Push時**: main/devブランチへのpushで監視実行
- **比較分析**: PRの変更前後でサイズ比較

### レポートの読み方

```
✅ 総合サイズ: 756.3 KB / 1000.0 KB (75.6%)
✅ JavaScript合計: 623.1 KB / 800.0 KB (77.9%)
⚠️ 初期読み込みJS: 425.7 KB / 500.0 KB (85.1%)
✅ CSS合計: 133.2 KB / 150.0 KB (88.8%)
```

- ✅ 正常: 制限内
- ⚠️ 警告: 80%を超過
- ❌ エラー: 制限を超過

---

## 最適化のベストプラクティス

### 1. 動的インポート（コードスプリッティング）

```tsx
// ❌ 避ける：静的インポート（大きなコンポーネント）
import HeavyComponent from './HeavyComponent'

// ✅ 推奨：Next.js dynamic imports
import dynamic from 'next/dynamic'
const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
  loading: () => <div>Loading...</div>,
})
```

### 2. ライブラリのTree-shaking

```tsx
// ❌ 避ける：ライブラリ全体のインポート
import * as lodash from 'lodash'

// ✅ 推奨：必要な関数のみインポート
import { debounce } from 'lodash'
import { format } from 'date-fns'
```

### 3. バレルファイルの適切な使用

```tsx
// ❌ 避ける：バレルファイルから大量インポート
import { A, B, C, D, E, F } from '@/components'

// ✅ 推奨：直接インポート
import A from '@/components/A'
import B from '@/components/B'
```

---

## カスタム設定

### 制限値の変更

```javascript
// scripts/bundle-check.js
const BUNDLE_LIMITS = {
  maxTotalJS: 800 * 1024,
  maxInitialJS: 500 * 1024,
  maxChunkJS: 250 * 1024,
  maxTotalCSS: 150 * 1024,
  maxInitialCSS: 100 * 1024,
  maxTotal: 1000 * 1024,
  warningThreshold: 0.8,
}
```

---

## トラブルシューティング

### バンドルサイズが突然増加した場合

1. **新しい依存関係**: `package.json` の変更を確認
2. **大きなアセット**: 画像やフォントファイルの追加を確認
3. **コードの重複**: ESLintの `import/no-duplicates` エラーを確認

### ビルドエラーが発生する場合

```bash
rm -rf .next
npm run build:fallback

# 依存関係の再インストール
rm -rf node_modules package-lock.json
npm install
```

---

## 機能追加時のチェックリスト

- [ ] 新しいライブラリは必要最小限か?
- [ ] Tree-shakingは有効か?
- [ ] 動的インポートは適用可能か?
- [ ] `npm run bundle:check` は通過するか?

---

## 関連ページ

- [Next.js最適化](?path=/docs/docs-実装ガイド-next-js最適化--docs)
- [パフォーマンス](?path=/docs/docs-実装ガイド-パフォーマンス--docs)

---

**最終更新**: 2026-02-12 | **バージョン**: v1.0
