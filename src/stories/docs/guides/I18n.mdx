import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Docs/Guides/i18n" />

# i18n 実装ガイド

Dayoptの国際化パターン。next-intlを使用し、全UIテキストを翻訳キーで管理する。

---

## ディレクトリ構造

```
messages/
├── en/                    # 英語
│   ├── common.json        # 共通UI
│   ├── auth.json          # 認証
│   ├── calendar.json      # カレンダー
│   └── ...
└── ja/                    # 日本語
    └── (同構造)

src/i18n/
├── routing.ts             # ルーティング設定
├── request.ts             # メッセージローダー（NAMESPACES定義）
└── navigation.ts          # next-intl ナビゲーション
```

---

## 命名規則

### ファイル名

| ルール | 例 |
|--------|-----|
| 1ファイル = 1ドメイン | `calendar.json` → calendarドメインのみ |
| 単数形 | `tag.json` ✅ / `tags.json` ❌ |
| camelCase | `aiChat.json` ✅ / `ai-chat.json` ❌ |

**例外**: `settings`, `stats` は英語で複数形が自然なため許容

### キー構造

```
domain.section.key
```

| 階層 | 説明 | 例 |
|------|------|-----|
| 1 | ドメイン（ファイル名と一致） | `calendar` |
| 2 | 画面名 or UIセクション名 | `toolbar`, `modal`, `form` |
| 3 | 具体的な意味 | `title`, `description` |
| 4 | 特殊ケースのみ | `calendar.toolbar.view.month` |

### sectionの許容値

- 画面名: `login`, `dashboard`, `detail`, `list`
- UIセクション: `header`, `sidebar`, `modal`, `form`, `toolbar`
- 概念セクション: `validation`, `errors`, `actions`

### 良い例 / 悪い例

```json
// ✅ 良い例 (calendar.json)
{
  "calendar": {
    "toolbar": {
      "today": "Today",
      "view": {
        "month": "Month",
        "week": "Week"
      }
    }
  }
}

// ❌ 悪い例
{
  "cal_toolbar_today": "Today",      // フラット過ぎる
  "calendar.toolbar.today": "Today", // ドット区切りの文字列キー
  "Calendar": { }                    // PascalCase
}
```

---

## 使用方法

### Server Component

```typescript
import { getTranslations } from 'next-intl/server';

export default async function Page({ params }: { params: Promise<{ locale: string }> }) {
  const { locale } = await params;
  const t = await getTranslations({ locale });

  return <h1>{t('calendar.toolbar.today')}</h1>;
}
```

### Client Component

```typescript
'use client';

import { useTranslations } from 'next-intl';

export function CalendarToolbar() {
  const t = useTranslations();

  return <button>{t('calendar.toolbar.today')}</button>;
}
```

### ネームスペース指定

```typescript
const t = await getTranslations({ locale, namespace: 'calendar' });
t('toolbar.today'); // → calendar.toolbar.today
```

---

## ネームスペース一覧

| ネームスペース | 用途 |
|---------------|------|
| `app` | アプリ全般（メタデータ等） |
| `auth` | 認証 |
| `board` | ボード |
| `calendar` | カレンダー |
| `common` | 共通UI |
| `error` | エラーメッセージ |
| `legal` | 法的文書 |
| `navigation` | ナビゲーション |
| `notification` | 通知 |
| `settings` | 設定（例外: 複数形） |
| `stats` | 統計（例外: 複数形） |
| `table` | テーブル |
| `tag` | タグ |

---

## メッセージファイルの構造

### 基本ルール

各JSONファイルは**ネームスペース名と一致するトップレベルキー**を持つ。`src/i18n/request.ts` が全ファイルを `Object.assign` でフラットにマージするため、トップレベルキーがそのままグローバルなネームスペースになる。

```json
// messages/en/calendar.json
{
  "calendar": {        // ← ファイル名と一致するトップレベルキー
    "toolbar": { ... },
    "event": { ... }
  }
}
```

> **重要**: トップレベルに複数のキーを置かないこと。`useTranslations('calendar')` は `calendar` キー配下のみをスコープとするため、兄弟キーにはアクセスできない。

```json
// ❌ 悪い例: 兄弟キーが useTranslations('calendar') からアクセス不可
{
  "calendar": { ... },
  "calendarActions": { ... }  // ← 別ネームスペース扱いになる
}

// ✅ 良い例: すべて calendar 配下に統合
{
  "calendar": {
    "actions": { ... }  // ← t('calendar.actions.xxx') でアクセス可能
  }
}
```

### common.json の構造

`common.json` は全Feature横断で使う共通キーを管理する。`common` キー配下に以下のセクションが存在する。

```
common
├── actions        # ボタンラベル: save, cancel, close, delete, create, edit, ...
├── confirm        # 確認ダイアログ: delete, archive, bulkDelete, recurring
├── aria           # アクセシビリティ: openMenu, selectColor, selectDate, ...
├── form           # フォーム: required, optional, processing
├── validation     # バリデーション: required, title.maxLength, password.*, ...
├── errors         # エラー: generic, auth.*, mfa.*, calendar.*
├── status         # ステータス: loading, success, error, warning, info
├── time           # 相対時間: today, yesterday, daysAgo, minutesAgo, ...
├── recurrence     # 繰り返し: daily, weekly, monthly, dialog.*
├── reminder       # リマインダー: none, atStart, min10, min30, ...
├── suggest        # サジェスト入力: recentHistory, loading, noResults
├── createNew      # 新規作成メニュー: plan, task, tag
├── createSheet    # 作成シート: plan, record, history
├── dates          # 日付フォーマット: formats.monthDay, formats.dateTime, ...
├── language       # 言語切替: current, switch, english, japanese
├── theme          # テーマ: light, dark
├── userProfile    # ユーザープロフィール
├── search         # 検索: shortcut
├── comingSoon     # "近日公開" (文字列)
├── toast          # トースト通知
└── (その他フラットキー) # apply, loading, reload, back, next, ...
```

### 翻訳キーの使い分け

| パターン | 例 | 用途 |
|---------|-----|------|
| `useTranslations()` | `t('common.actions.save')` | 複数ネームスペースを参照するコンポーネント |
| `useTranslations('common')` | `t('actions.save')` | common のみ参照するコンポーネント |
| `useTranslations('common.suggest')` | `t('loading')` | 特定セクションのみ参照する場合 |

**推奨**: 多くのコンポーネントは `common` + Feature固有キーの両方を使うため、`useTranslations()`（ルートスコープ）が最も一般的。

### Storybook のメッセージ管理

Storybookでは `.storybook/preview.tsx` で `NextIntlClientProvider` に直接メッセージオブジェクトを渡している。

```tsx
// .storybook/preview.tsx
const messages = {
  common: {
    actions: { save: '保存', cancel: 'キャンセル', ... },
    confirm: { recurring: { ... } },
    ...
  },
  calendar: { ... },
  tags: { ... },
};
```

**ルール**:
- 実際のJSONファイルと**同じキー構造**を維持すること
- Storyに必要なキーのみを含める（全キーのコピーは不要）
- 新しいStoryを追加する際、翻訳キーが不足していれば `preview.tsx` のメッセージに追加する
- `npm run i18n:check` は `messages/` ディレクトリのみ検証するため、`preview.tsx` の整合性は手動で確認する

---

## 新規ネームスペース追加手順

1. `messages/en/{namespace}.json` を作成
2. `messages/ja/{namespace}.json` を作成
3. `src/i18n/request.ts` の `NAMESPACES` 配列に追加

```typescript
const NAMESPACES = [
  // ... 既存
  'newNamespace', // 追加
] as const;
```

---

## 検証コマンド

```bash
npm run i18n:check    # 翻訳キーの差分チェック（en/ja）
npm run i18n:unused   # 未使用キーの検出
```

---

## チェックリスト

- [ ] すべてのUI文字列を翻訳キーに置き換え
- [ ] `messages/ja/` と `messages/en/` 両方に翻訳ファイルを追加
- [ ] `src/i18n/request.ts` の `NAMESPACES` に追加
- [ ] Server Component → `getTranslations()`
- [ ] Client Component → `useTranslations()`
- [ ] ハードコードされた日本語・英語が残っていないか確認
- [ ] `npm run i18n:check` で差分がないことを確認

---

**最終更新**: 2026-02-19 | **バージョン**: v1.1
