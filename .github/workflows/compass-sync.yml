name: Compass Submodule Auto Sync

on:
  repository_dispatch:
    types: [compass-updated]
  workflow_dispatch:
    inputs:
      compass_ref:
        description: 'Compass repository reference to sync'
        required: false
        default: 'dev'

jobs:
  sync-compass:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout app repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Update compass submodule
        run: |
          cd compass
          git fetch origin
          git checkout dev
          git pull origin dev
          cd ..
          
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet compass; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes in compass submodule"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in compass submodule"
          fi

      - name: Get compass commit info
        if: steps.changes.outputs.changes == 'true'
        id: compass_info
        run: |
          cd compass
          COMPASS_COMMIT=$(git rev-parse HEAD)
          COMPASS_MESSAGE=$(git log -1 --pretty=format:"%s")
          echo "commit=$COMPASS_COMMIT" >> $GITHUB_OUTPUT
          echo "message=$COMPASS_MESSAGE" >> $GITHUB_OUTPUT
          cd ..

      - name: Create Pull Request
        if: steps.changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            feat: compassサブモジュールを最新版に自動更新
            
            - Compass commit: ${{ steps.compass_info.outputs.commit }}
            - 変更内容: ${{ steps.compass_info.outputs.message }}
            
            🤖 自動生成プルリクエスト
          title: "🔄 Compass自動同期: ${{ steps.compass_info.outputs.message }}"
          body: |
            ## 📝 概要
            
            Compassリポジトリの更新を自動検出し、サブモジュールを最新版に同期しました。
            
            ## 🔄 変更内容
            
            - **Compass Commit**: `${{ steps.compass_info.outputs.commit }}`
            - **変更概要**: ${{ steps.compass_info.outputs.message }}
            
            ## ✅ チェック項目
            
            - [ ] ドキュメント内容を確認
            - [ ] 関連するコードに影響がないか確認
            - [ ] CI/CDが正常に動作するか確認
            
            ---
            
            🤖 このプルリクエストは自動生成されました。
            不要な場合はクローズしてください。
          branch: auto-sync/compass-update-${{ github.run_number }}
          delete-branch: true
          draft: false
          labels: |
            compass
            auto-sync
            documentation

      - name: Auto-approve and merge (optional)
        if: steps.changes.outputs.changes == 'true' && contains(steps.compass_info.outputs.message, '[auto-merge]')
        run: |
          echo "Auto-merge tag detected. Consider setting up auto-merge rules."
          # gh pr merge --auto --squash --delete-branch
          # (Requires GITHUB_TOKEN with appropriate permissions)