name: Compass Submodule Auto Sync

on:
  repository_dispatch:
    types: [compass-updated]
  workflow_dispatch:
    inputs:
      compass_ref:
        description: 'Compass repository reference to sync'
        required: false
        default: 'dev'

jobs:
  sync-compass:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout app repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Update compass submodule
        run: |
          cd compass
          git fetch origin
          git checkout dev
          git pull origin dev
          cd ..
          
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet compass; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes in compass submodule"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in compass submodule"
          fi

      - name: Get compass commit info
        if: steps.changes.outputs.changes == 'true'
        id: compass_info
        run: |
          cd compass
          COMPASS_COMMIT=$(git rev-parse HEAD)
          COMPASS_MESSAGE=$(git log -1 --pretty=format:"%s")
          echo "commit=$COMPASS_COMMIT" >> $GITHUB_OUTPUT
          echo "message=$COMPASS_MESSAGE" >> $GITHUB_OUTPUT
          cd ..

      - name: Create Pull Request
        if: steps.changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            feat: compassã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æœ€æ–°ç‰ˆã«è‡ªå‹•æ›´æ–°
            
            - Compass commit: ${{ steps.compass_info.outputs.commit }}
            - å¤‰æ›´å†…å®¹: ${{ steps.compass_info.outputs.message }}
            
            ğŸ¤– è‡ªå‹•ç”Ÿæˆãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          title: "ğŸ”„ Compassè‡ªå‹•åŒæœŸ: ${{ steps.compass_info.outputs.message }}"
          body: |
            ## ğŸ“ æ¦‚è¦
            
            Compassãƒªãƒã‚¸ãƒˆãƒªã®æ›´æ–°ã‚’è‡ªå‹•æ¤œå‡ºã—ã€ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æœ€æ–°ç‰ˆã«åŒæœŸã—ã¾ã—ãŸã€‚
            
            ## ğŸ”„ å¤‰æ›´å†…å®¹
            
            - **Compass Commit**: `${{ steps.compass_info.outputs.commit }}`
            - **å¤‰æ›´æ¦‚è¦**: ${{ steps.compass_info.outputs.message }}
            
            ## âœ… ãƒã‚§ãƒƒã‚¯é …ç›®
            
            - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’ç¢ºèª
            - [ ] é–¢é€£ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã«å½±éŸ¿ãŒãªã„ã‹ç¢ºèª
            - [ ] CI/CDãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹ç¢ºèª
            
            ---
            
            ğŸ¤– ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
            ä¸è¦ãªå ´åˆã¯ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„ã€‚
          branch: auto-sync/compass-update-${{ github.run_number }}
          delete-branch: true
          draft: false
          labels: |
            compass
            auto-sync
            documentation

      - name: Auto-approve and merge (optional)
        if: steps.changes.outputs.changes == 'true' && contains(steps.compass_info.outputs.message, '[auto-merge]')
        run: |
          echo "Auto-merge tag detected. Consider setting up auto-merge rules."
          # gh pr merge --auto --squash --delete-branch
          # (Requires GITHUB_TOKEN with appropriate permissions)