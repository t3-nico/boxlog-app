name: License Audit (Monthly)

# æœˆæ¬¡ã§ãƒ©ã‚¤ã‚»ãƒ³ã‚¹å¤‰æ›´ã‚’ç›£è¦–ï¼ˆå‹•çš„ãƒ©ã‚¤ã‚»ãƒ³ã‚¹å¤‰æ›´ã®æ—©æœŸæ¤œå‡ºï¼‰
on:
  schedule:
    - cron: '0 0 1 * *' # æ¯æœˆ1æ—¥ 00:00 UTC

  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
  workflow_dispatch:

env:
  NODE_VERSION: '18'

permissions:
  contents: read
  issues: write # Issueä½œæˆç”¨

jobs:
  license-audit:
    name: ğŸ”’ Monthly License Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run License Risk Checker
        id: risk_check
        run: |
          echo "## ğŸ”’ Monthly License Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if npm run license:check-risks 2>&1 | tee /tmp/license-risks.log; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "### âœ… Status: SAFE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All dependencies are using approved licenses." >> $GITHUB_STEP_SUMMARY
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "### âš ï¸ Status: RISKS DETECTED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/license-risks.log | tail -30 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“Š Generate License Statistics
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š License Distribution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          npm run license:audit 2>&1 | grep -E "â”œâ”€|â””â”€" | head -20 >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ğŸš¨ Create Issue on Risk Detection
        if: steps.risk_check.outputs.status == 'failed'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const logContent = fs.readFileSync('/tmp/license-risks.log', 'utf8');

            const issueBody = [
              '## ğŸ”’ Monthly License Audit - Risk Detected',
              '',
              '### âš ï¸ Summary',
              '',
              'The automated monthly license audit has detected potential license risks in the project dependencies.',
              '',
              '### ğŸ“‹ Details',
              '',
              '```',
              logContent,
              '```',
              '',
              '### ğŸ”§ Action Required',
              '',
              '1. Review the detected risks above',
              '2. Check if any dependencies have changed licenses',
              '3. Remove or replace packages with prohibited licenses',
              '4. Update `.licensrc.json` if necessary',
              '5. Run `npm run license:check-risks` locally to verify',
              '',
              '### ğŸ”— Resources',
              '',
              `- [License Compliance Plan](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/legal/LICENSE_COMPLIANCE_PLAN.md)`,
              '- [Approved Licenses](.licensrc.json)',
              '',
              '### ğŸ“… Audit Date',
              '',
              new Date().toISOString(),
              '',
              '---',
              '<sub>ğŸ¤– Automated by Monthly License Audit</sub>'
            ].join('\n');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ License Risk Detected - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['security', 'license', 'automated'],
            });

            console.log(`Created issue #${issue.data.number}`);

      - name: âŒ Fail if risks detected
        if: steps.risk_check.outputs.status == 'failed'
        run: |
          echo "::error::âŒ License risks detected"
          echo "::error::Please check the workflow summary and created issue"
          exit 1

      - name: âœ… Success
        if: steps.risk_check.outputs.status == 'success'
        run: |
          echo "âœ… Monthly license audit passed"
          echo "All dependencies use approved licenses"
