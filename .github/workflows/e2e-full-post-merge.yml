name: ðŸŒ E2E Full Browser (Post-Merge)

# main ãƒžãƒ¼ã‚¸å¾Œã«ãƒ•ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆéžãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

# åŒã˜ãƒ–ãƒ©ãƒ³ãƒã§è¤‡æ•°å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã€å¤ã„å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: e2e-full-${{ github.sha }}
  cancel-in-progress: false # main ã§ã¯é€”ä¸­ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãªã„

permissions:
  contents: read
  issues: write # å¤±æ•—æ™‚ã®Issueä½œæˆ

jobs:
  e2e-full:
    name: ðŸ§ª E2E - ${{ matrix.project }}
    runs-on: ubuntu-latest
    environment: development
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        project:
          - chromium
          - firefox
          - webkit
          - 'Mobile Chrome'
          - 'Mobile Safari'
          - iPad

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright Browsers
        run: |
          if [ "${{ matrix.project }}" = "Mobile Chrome" ]; then
            npx playwright install --with-deps chromium chromium-headless-shell
          elif [ "${{ matrix.project }}" = "Mobile Safari" ]; then
            npx playwright install --with-deps webkit
          elif [ "${{ matrix.project }}" = "iPad" ]; then
            npx playwright install --with-deps webkit chromium-headless-shell
          elif [ "${{ matrix.project }}" = "chromium" ]; then
            npx playwright install --with-deps chromium chromium-headless-shell
          else
            npx playwright install --with-deps ${{ matrix.project }}
          fi

      - name: ðŸŒ Run E2E tests - ${{ matrix.project }}
        run: npm run test:e2e -- --project="${{ matrix.project }}"
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL || 'https://dummy.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1bW15IiXJvbGUiOiJhbm9uIiwiaWF0IjoxNjQ1MTkyMDAwLCJleHAiOjE5NjA1NjgwMDB9.DUMMY_KEY_FOR_TESTING' }}
          NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL || 'http://localhost:3000' }}

      - name: ðŸ“Š Upload Playwright Report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: playwright-report-full-${{ matrix.project }}
          path: playwright-report/
          retention-days: 14

      - name: ðŸ“¸ Upload Screenshots
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: failure()
        with:
          name: screenshots-full-${{ matrix.project }}
          path: test-results/
          retention-days: 14

  # çµæžœã‚µãƒžãƒªãƒ¼ã¨Issueä½œæˆ
  summary:
    name: ðŸ“Š E2E Full Summary
    runs-on: ubuntu-latest
    needs: [e2e-full]
    if: always()

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸŒ E2E Full Browser Test (Post-Merge)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Overall | ${{ needs.e2e-full.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš¨ Create Issue on Failure
        if: needs.e2e-full.result == 'failure'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const shortSha = '${{ github.sha }}'.substring(0, 7);
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const commitUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${{ github.sha }}`;

            const body = [
              '## ðŸš¨ E2E Full Browser Test Failure (Post-Merge)',
              '',
              `**Commit**: [\`${shortSha}\`](${commitUrl})`,
              `**Workflow Run**: [View Details](${runUrl})`,
              '',
              '### Summary',
              '',
              'Full browser E2E tests failed after merging to main. This may indicate browser compatibility issues.',
              '',
              '### Tested Browsers',
              '- Chrome (Chromium)',
              '- Firefox',
              '- Safari (WebKit)',
              '- Mobile Chrome (Pixel 5)',
              '- Mobile Safari (iPhone 12)',
              '- iPad Pro',
              '',
              '### Action Required',
              '',
              `1. Review the [workflow logs](${runUrl})`,
              '2. Download the Playwright reports from artifacts',
              '3. Identify and fix browser-specific issues',
              '4. Consider if a hotfix or revert is needed',
              '',
              '---',
              '<sub>ðŸ¤– Automated by E2E Full Post-Merge Test</sub>',
            ].join('\n');

            // åŒã˜ã‚³ãƒŸãƒƒãƒˆã®IssueãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'e2e,post-merge',
              state: 'open',
            });

            const existingForCommit = existingIssues.find(
              issue => issue.title.includes(shortSha)
            );

            if (!existingForCommit) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ E2E Failure (Post-Merge): ${shortSha}`,
                body: body,
                labels: ['e2e', 'post-merge', 'bug']
              });
            }

      - name: âœ… Success
        if: needs.e2e-full.result == 'success'
        run: |
          echo "âœ… All full browser E2E tests passed!" >> $GITHUB_STEP_SUMMARY
