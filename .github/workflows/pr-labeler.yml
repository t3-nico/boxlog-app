name: ğŸ·ï¸ PR Auto Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write

jobs:
  # =====================================
  # 0. PRã‚¿ã‚¤ãƒˆãƒ«ã®Conventional Commitsæ¤œè¨¼
  # =====================================
  validate-title:
    name: âœ… Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: âœ… Check Conventional Commits format
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const title = context.payload.pull_request.title;

            // Conventional Commits ãƒ‘ã‚¿ãƒ¼ãƒ³
            // type(scope)!: description
            const pattern = /^(feat|fix|docs|style|refactor|perf|test|build|ci|chore)(\(.+\))?!?:\s.+$/;

            if (!pattern.test(title)) {
              const errorMessage = `
            âŒ **PRã‚¿ã‚¤ãƒˆãƒ«ãŒConventional Commitså½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“**

            ç¾åœ¨ã®ã‚¿ã‚¤ãƒˆãƒ«: \`${title}\`

            ### æ­£ã—ã„å½¢å¼
            \`\`\`
            <type>(<scope>): <description>
            \`\`\`

            ### ä½¿ç”¨å¯èƒ½ãªtype
            | type | èª¬æ˜ |
            |------|------|
            | \`feat\` | æ–°æ©Ÿèƒ½ |
            | \`fix\` | ãƒã‚°ä¿®æ­£ |
            | \`docs\` | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |
            | \`style\` | ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ |
            | \`refactor\` | ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° |
            | \`perf\` | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ |
            | \`test\` | ãƒ†ã‚¹ãƒˆ |
            | \`build\` | ãƒ“ãƒ«ãƒ‰ |
            | \`ci\` | CI/CD |
            | \`chore\` | ãã®ä»– |

            ### ä¾‹
            - âœ… \`feat: ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½ã‚’è¿½åŠ \`
            - âœ… \`fix(auth): ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£\`
            - âœ… \`docs: READMEã‚’æ›´æ–°\`
            - âŒ \`fixed login bug\`
            - âŒ \`Update README\`
            `;

              core.setFailed(errorMessage);
            } else {
              console.log(`âœ… PRã‚¿ã‚¤ãƒˆãƒ«ã¯æ­£ã—ã„å½¢å¼ã§ã™: ${title}`);
            }

  # =====================================
  # 1. PRã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰type/ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸
  # =====================================
  type-label:
    name: ğŸ·ï¸ Type Label
    runs-on: ubuntu-latest
    needs: validate-title
    steps:
      - name: ğŸ·ï¸ Add type label from PR title
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const title = context.payload.pull_request.title;
            const prNumber = context.payload.pull_request.number;

            // Conventional Commits ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ãƒ©ãƒ™ãƒ«ã‚’æ±ºå®š
            const typeMap = {
              '^feat(\\(.+\\))?!?:': 'type/feature',
              '^fix(\\(.+\\))?!?:': 'type/fix',
              '^docs(\\(.+\\))?!?:': 'type/docs',
              '^style(\\(.+\\))?!?:': 'type/style',
              '^refactor(\\(.+\\))?!?:': 'type/refactor',
              '^perf(\\(.+\\))?!?:': 'type/perf',
              '^test(\\(.+\\))?!?:': 'type/test',
              '^build(\\(.+\\))?!?:': 'type/build',
              '^ci(\\(.+\\))?!?:': 'type/ci',
              '^chore(\\(.+\\))?!?:': 'type/chore',
            };

            let typeLabel = null;
            for (const [pattern, label] of Object.entries(typeMap)) {
              if (new RegExp(pattern, 'i').test(title)) {
                typeLabel = label;
                break;
              }
            }

            if (typeLabel) {
              // æ—¢å­˜ã®type/ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
              const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });

              // ä»–ã®type/ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
              const typeLabelsToRemove = currentLabels
                .filter(l => l.name.startsWith('type/') && l.name !== typeLabel)
                .map(l => l.name);

              for (const label of typeLabelsToRemove) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label,
                });
              }

              // æ–°ã—ã„ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: [typeLabel],
              });

              console.log(`Added label: ${typeLabel}`);
            }

            // Breaking Changeæ¤œå‡ºï¼ˆ!ãƒãƒ¼ã‚¯ã¾ãŸã¯BREAKING CHANGEï¼‰
            if (title.includes('!:') || title.toUpperCase().includes('BREAKING')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['impact/breaking'],
              });
              console.log('Added label: impact/breaking');
            }

  # =====================================
  # 2. å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰area/ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸
  # =====================================
  area-label:
    name: ğŸ—‚ï¸ Area Label
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: ğŸ—‚ï¸ Add area labels from changed files
        uses: actions/labeler@8558fd74291d67161a8a78ce36a881fa63b766a9 # v5.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

  # =====================================
  # 3. å¤‰æ›´è¡Œæ•°ã‹ã‚‰size/ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸
  # =====================================
  size-label:
    name: ğŸ“ Size Label
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ Add size label from changed lines
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const additions = context.payload.pull_request.additions;
            const deletions = context.payload.pull_request.deletions;
            const totalChanges = additions + deletions;

            // ã‚µã‚¤ã‚ºåˆ¤å®š
            let sizeLabel;
            if (totalChanges <= 10) {
              sizeLabel = 'size/xs';
            } else if (totalChanges <= 50) {
              sizeLabel = 'size/s';
            } else if (totalChanges <= 200) {
              sizeLabel = 'size/m';
            } else if (totalChanges <= 500) {
              sizeLabel = 'size/l';
            } else {
              sizeLabel = 'size/xl';
            }

            // æ—¢å­˜ã®size/ãƒ©ãƒ™ãƒ«ã‚’å–å¾—ã—ã¦å‰Šé™¤
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const sizeLabelsToRemove = currentLabels
              .filter(l => l.name.startsWith('size/') && l.name !== sizeLabel)
              .map(l => l.name);

            for (const label of sizeLabelsToRemove) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: label,
              });
            }

            // æ–°ã—ã„ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [sizeLabel],
            });

            console.log(`Total changes: ${totalChanges} â†’ ${sizeLabel}`);
