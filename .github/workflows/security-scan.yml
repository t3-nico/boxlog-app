name: ðŸ›¡ï¸ OWASP ZAP Security Scan

on:
  schedule:
    # æ¯Žé€±æœˆæ›œ 2:00 JST ã«å®Ÿè¡Œ
    - cron: '0 17 * * 0'  # æ—¥æ›œ 17:00 UTC = æœˆæ›œ 2:00 JST
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Scan type'
        required: true
        default: 'baseline'
        type: choice
        options:
          - baseline
          - full

env:
  TARGET_URL: 'https://boxlog-app.vercel.app'

# åŒã˜ãƒ–ãƒ©ãƒ³ãƒã§è¤‡æ•°å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã€å¤ã„å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =====================================
  # ðŸ” ZAP Baseline Scanï¼ˆåŸºæœ¬ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
  # =====================================
  zap-baseline:
    name: ðŸ” ZAP Baseline Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.inputs.scan_type != 'full'

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.TARGET_URL }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -T 15'  # AJAX spider, JSON report, 15min timeout
          fail_action: false  # Phase 1ã§ã¯å¤±æ•—ã•ã›ãªã„

      - name: ðŸ“Š Upload ZAP Report (HTML)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-baseline-report-html
          path: report_html.html
          retention-days: 30

      - name: ðŸ“Š Upload ZAP Report (JSON)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-baseline-report-json
          path: report_json.json
          retention-days: 30

      - name: ðŸ’¬ Create GitHub Issue for High/Critical Alerts
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // JSONãƒ¬ãƒãƒ¼ãƒˆèª­ã¿è¾¼ã¿
            let report;
            try {
              const data = fs.readFileSync('report_json.json', 'utf8');
              report = JSON.parse(data);
            } catch (error) {
              console.log('No JSON report found');
              return;
            }

            // High/Critical ã‚¢ãƒ©ãƒ¼ãƒˆã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const alerts = report.site?.[0]?.alerts || [];
            const criticalAlerts = alerts.filter(a =>
              a.riskcode === '3' || a.riskcode === '2'  // High or Critical
            );

            if (criticalAlerts.length === 0) {
              console.log('âœ… No critical alerts found');
              return;
            }

            // Issueä½œæˆ
            const body = `## ðŸš¨ OWASP ZAP Security Scan Alert

            **Scan Date**: ${new Date().toISOString()}
            **Target**: ${process.env.TARGET_URL}
            **Critical/High Alerts**: ${criticalAlerts.length}

            ### Alerts

            ${criticalAlerts.map(alert => `
            #### ${alert.name}
            - **Risk**: ${alert.riskdesc}
            - **Confidence**: ${alert.confidence}
            - **Description**: ${alert.desc}
            - **Solution**: ${alert.solution}
            - **URLs**: ${alert.instances?.length || 0} instance(s)
            `).join('\n')}

            ### Reports
            - [HTML Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [JSON Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            **Auto-generated by OWASP ZAP Security Scan**
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Security Alert: ${criticalAlerts.length} Critical/High Issues Found`,
              body: body,
              labels: ['security', 'P0-urgent']
            });

  # =====================================
  # ðŸ” ZAP Full Scanï¼ˆå®Œå…¨ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
  # =====================================
  zap-full:
    name: ðŸ” ZAP Full Scan
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: github.event.inputs.scan_type == 'full'

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: ${{ env.TARGET_URL }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -T 60'
          fail_action: false

      - name: ðŸ“Š Upload Full Scan Report (HTML)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-full-report-html
          path: report_html.html
          retention-days: 90

      - name: ðŸ“Š Upload Full Scan Report (JSON)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-full-report-json
          path: report_json.json
          retention-days: 90

  # =====================================
  # ðŸ“Š Scan Summary
  # =====================================
  scan-summary:
    name: ðŸ“Š Scan Summary
    runs-on: ubuntu-latest
    needs: [zap-baseline]
    if: always() && needs.zap-baseline.result != 'skipped'

    steps:
      - name: ðŸ“¥ Download Reports
        uses: actions/download-artifact@v4
        with:
          name: zap-baseline-report-json
        continue-on-error: true

      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ›¡ï¸ OWASP ZAP Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target**: ${{ env.TARGET_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f report_json.json ]; then
            # JSONãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰çµ±è¨ˆã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
            echo "âœ… Scan completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š Detailed reports are available in the artifacts." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No report found" >> $GITHUB_STEP_SUMMARY
          fi
