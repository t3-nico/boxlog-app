name: ðŸŒ E2E Weekly Full Browser Test

# é€±æ¬¡ã§E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆChromium + Mobile Chromeï¼‰
on:
  schedule:
    # æ¯Žé€±æœˆæ›œ 9:00 JST (0:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: æœ€å°æ¨©é™ã®åŽŸå‰‡
permissions:
  contents: read
  issues: write # å¤±æ•—æ™‚ã®Issueä½œæˆ

jobs:
  e2e-full:
    name: ðŸ§ª E2E - ${{ matrix.project }}
    runs-on: ubuntu-latest
    environment: development
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        project:
          - chromium
          - 'Mobile Chrome'

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright Browsers
        run: |
          npx playwright install --with-deps chromium chromium-headless-shell

      - name: ðŸŒ Run E2E tests - ${{ matrix.project }}
        id: e2e
        run: npm run test:e2e -- --project="${{ matrix.project }}"
        env:
          # vars: å…¬é–‹ç’°å¢ƒå¤‰æ•°ï¼ˆNEXT_PUBLIC_*ï¼‰ã¯Repository Variablesã§ç®¡ç†
          NEXT_PUBLIC_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL || 'https://dummy.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1bW15IiXJvbGUiOiJhbm9uIiwiaWF0IjoxNjQ1MTkyMDAwLCJleHAiOjE5NjA1NjgwMDB9.DUMMY_KEY_FOR_TESTING' }}
          NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL || 'http://localhost:3000' }}

      - name: ðŸ“Š Upload Playwright Report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: playwright-report-weekly-${{ matrix.project }}
          path: playwright-report/
          retention-days: 30

      - name: ðŸ“¸ Upload Screenshots
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: failure()
        with:
          name: screenshots-weekly-${{ matrix.project }}
          path: test-results/
          retention-days: 30

  # çµæžœã‚µãƒžãƒªãƒ¼ã¨Issueä½œæˆ
  summary:
    name: ðŸ“Š Weekly E2E Summary
    runs-on: ubuntu-latest
    needs: [e2e-full]
    if: always()

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸŒ Weekly E2E Full Browser Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Overall | ${{ needs.e2e-full.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš¨ Create Issue on Failure
        if: needs.e2e-full.result == 'failure'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## ðŸš¨ Weekly E2E Test Failure',
              '',
              `**Date**: ${today}`,
              `**Workflow Run**: [View Details](${runUrl})`,
              '',
              '### Summary',
              '',
              'The weekly full browser E2E test has detected failures. This may indicate browser compatibility issues that need attention.',
              '',
              '### Tested Browsers',
              '- Chrome (Chromium)',
              '- Mobile Chrome (Pixel 5)',
              '',
              '### Action Required',
              '',
              `1. Review the [workflow logs](${runUrl})`,
              '2. Download the Playwright reports from artifacts',
              '3. Identify and fix browser-specific issues',
              '4. Consider if the issue affects production users',
              '',
              '---',
              '<sub>ðŸ¤– Automated by Weekly E2E Test</sub>',
            ].join('\n');

            // åŒã˜æ—¥ã®IssueãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'e2e,weekly-test',
              state: 'open',
            });

            const existingToday = existingIssues.find(
              issue => issue.title.includes(today)
            );

            if (!existingToday) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Weekly E2E Test Failure - ${today}`,
                body: body,
                labels: ['e2e', 'weekly-test', 'bug']
              });
            }

      - name: âœ… Success
        if: needs.e2e-full.result == 'success'
        run: |
          echo "âœ… All weekly E2E tests passed!" >> $GITHUB_STEP_SUMMARY
