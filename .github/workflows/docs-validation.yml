name: ğŸ“š Docs Validation

on:
  push:
    branches: [main]
    paths:
      - '**.md'
      - 'CLAUDE.md'
      - 'src/**/CLAUDE.md'
      - 'docs/**/*.md'
  pull_request:
    branches: [main]
    paths:
      - '**.md'
  workflow_dispatch:

# åŒã˜ãƒ–ãƒ©ãƒ³ãƒã§è¤‡æ•°å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã€å¤ã„å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  link-check:
    name: ğŸ”— Check Markdown Links
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: ğŸ”— Check links in all markdown files
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          config-file: '.github/markdown-link-check.json'
          folder-path: '.'
          file-path: './CLAUDE.md'
          max-depth: -1

  reference-check:
    name: ğŸ“‚ Check File References
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8  # v4.0.2
        with:
          node-version: '18'

      - name: ğŸ“‚ Validate CLAUDE.md file references
        run: node scripts/validate-doc-references.js

  consistency-check:
    name: ğŸ“Š Docs Consistency Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8  # v4.0.2
        with:
          node-version: '18'

      - name: ğŸ“Š Run docs consistency check
        run: npm run docs:check

  rule-check:
    name: ğŸš¨ Check CLAUDE.md Rule Violations
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8  # v4.0.2
        with:
          node-version: '18'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸš¨ Check CLAUDE.md rule violations
        run: node scripts/validate-claude-rules.js

      - name: ğŸ’¬ Comment PR with violations (if any)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const fs = require('fs')
            const violations = fs.readFileSync('.violations.json', 'utf8')

            const comment = `## ğŸš¨ CLAUDE.md ãƒ«ãƒ¼ãƒ«é•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ

            ${violations}

            è©³ç´°ã¯ [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            `

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            })

  quality-gate:
    name: ğŸšª Docs Quality Gate
    runs-on: ubuntu-latest
    needs: [link-check, reference-check, consistency-check, rule-check]
    if: always()
    steps:
      - name: âœ… Check results
        run: |
          if [[ "${{ needs.link-check.result }}" != "success" ]]; then
            echo "âŒ Link check failed"
            exit 1
          fi
          if [[ "${{ needs.reference-check.result }}" != "success" ]]; then
            echo "âŒ Reference check failed"
            exit 1
          fi
          if [[ "${{ needs.consistency-check.result }}" != "success" ]]; then
            echo "âŒ Consistency check failed"
            exit 1
          fi
          if [[ "${{ needs.rule-check.result }}" != "success" ]]; then
            echo "âš ï¸  Rule violations found (non-blocking)"
          fi
          echo "âœ… All documentation checks passed!"
