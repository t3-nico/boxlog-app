name: ğŸ” 1Password Security Automation

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Security action to perform'
        required: true
        default: 'audit'
        type: choice
        options:
        - audit
        - compliance
        - cleanup
        - rotate

jobs:
  secrets-audit:
    name: ğŸ” Secrets Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'audit')

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ” Setup 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: ğŸ”‘ Authenticate with 1Password
        env:
          OP_CONNECT_HOST: ${{ secrets.OP_CONNECT_HOST }}
          OP_CONNECT_TOKEN: ${{ secrets.OP_CONNECT_TOKEN }}
        run: |
          echo "$OP_CONNECT_TOKEN" | op signin --raw

      - name: ğŸ” Run secrets audit
        run: npm run 1password:audit
        continue-on-error: true

      - name: ğŸ§¹ Detect unused secrets
        run: npm run 1password:cleanup
        continue-on-error: true

      - name: ğŸ“Š Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: secrets-audit-results
          path: |
            secrets-audit-*.json
            .boxlog-1password.log
          retention-days: 30

      - name: ğŸ’¬ Comment audit results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const auditFiles = require('glob').sync('secrets-audit-*.json');

            if (auditFiles.length > 0) {
              const audit = JSON.parse(fs.readFileSync(auditFiles[0], 'utf8'));

              const body = `## ğŸ” 1Password Security Audit

              **Audit Timestamp:** ${audit.timestamp}
              **Environment:** ${audit.environment}

              ### ğŸ“Š Secrets Inventory
              - **Total Secrets:** ${audit.secrets.length}
              - **Vaults:** ${[...new Set(audit.secrets.map(s => s.vault))].join(', ')}

              ### ğŸ” Security Status
              - **Recent Access Events:** ${audit.accessLog.length}
              - **Last Sync:** ${audit.timestamp}

              ${audit.secrets.length > 10 ? 'âš ï¸ **High secret count detected** - Consider reviewing for unused secrets' : 'âœ… **Secret count within normal range**'}

              ---
              ğŸ“– **Documentation:** [1Password Setup Guide](./docs/setup/1PASSWORD_SETUP.md)
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

  compliance-check:
    name: ğŸ“‹ Security Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'compliance')

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ” Setup 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: ğŸ”‘ Authenticate with 1Password
        env:
          OP_CONNECT_HOST: ${{ secrets.OP_CONNECT_HOST }}
          OP_CONNECT_TOKEN: ${{ secrets.OP_CONNECT_TOKEN }}
        run: |
          echo "$OP_CONNECT_TOKEN" | op signin --raw

      - name: ğŸ“‹ Generate compliance report
        run: npm run 1password:compliance

      - name: ğŸ“Š Analyze compliance score
        run: |
          COMPLIANCE_FILE=$(ls compliance-report-*.json | head -1)
          if [ -f "$COMPLIANCE_FILE" ]; then
            SCORE=$(cat "$COMPLIANCE_FILE" | jq -r '.score')
            echo "Compliance Score: $SCORE%"

            if [ "$SCORE" -lt 80 ]; then
              echo "âŒ Compliance score ($SCORE%) below threshold (80%)"
              echo "COMPLIANCE_FAILED=true" >> $GITHUB_ENV
            else
              echo "âœ… Compliance score ($SCORE%) meets requirements"
              echo "COMPLIANCE_PASSED=true" >> $GITHUB_ENV
            fi
          fi

      - name: ğŸ“Š Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: |
            compliance-report-*.json
            .boxlog-1password.log
          retention-days: 90

      - name: âŒ Fail on compliance issues
        if: env.COMPLIANCE_FAILED == 'true'
        run: |
          echo "Security compliance check failed. Please review the compliance report."
          exit 1

  secrets-rotation:
    name: ğŸ”„ Secrets Rotation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'rotate'
    environment: production

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ” Setup 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: ğŸ”‘ Authenticate with 1Password
        env:
          OP_CONNECT_HOST: ${{ secrets.OP_CONNECT_HOST }}
          OP_CONNECT_TOKEN: ${{ secrets.OP_CONNECT_TOKEN }}
        run: |
          echo "$OP_CONNECT_TOKEN" | op signin --raw

      - name: ğŸ”„ Rotate secrets
        run: npm run 1password:rotate
        env:
          # å®‰å…¨ãªrotationç’°å¢ƒå¤‰æ•°
          ROTATION_POLICY: "auto"
          BACKUP_BEFORE_ROTATION: "true"

      - name: ğŸ“Š Upload rotation report
        uses: actions/upload-artifact@v4
        with:
          name: secrets-rotation-report
          path: |
            secrets-rotation.log
            .boxlog-1password.log
          retention-days: 365

      - name: ğŸ“§ Notify rotation completion
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('secrets-rotation.log')) {
              const lastEntry = fs.readFileSync('secrets-rotation.log', 'utf8')
                .trim().split('\n').pop();
              const rotation = JSON.parse(lastEntry);

              console.log(`âœ… Secrets rotation completed successfully`);
              console.log(`Summary: ${rotation.summary.successful}/${rotation.summary.total} secrets rotated`);

              // Slack/Teamsé€šçŸ¥ã‚„ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’ã“ã“ã«è¿½åŠ å¯èƒ½
            }

  development-sync:
    name: ğŸ”„ Development Environment Sync
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ” Setup 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: ğŸ”‘ Authenticate with 1Password
        env:
          OP_CONNECT_HOST: ${{ secrets.OP_CONNECT_HOST }}
          OP_CONNECT_TOKEN: ${{ secrets.OP_CONNECT_TOKEN }}
        run: |
          echo "$OP_CONNECT_TOKEN" | op signin --raw

      - name: ğŸ”„ Sync development environment
        run: npm run 1password:sync

      - name: âœ… Verify sync success
        run: |
          if [ -f ".env.local" ]; then
            echo "âœ… Environment sync completed"
            ENV_COUNT=$(grep -c "=" .env.local || true)
            echo "Environment variables synced: $ENV_COUNT"
          else
            echo "âŒ Environment sync failed"
            exit 1
          fi

  security-monitoring:
    name: ğŸ›¡ï¸ Continuous Security Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 8
    if: github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Scan for hardcoded secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: ğŸ” Check for 1Password references
        run: |
          # 1Passwordå‚ç…§å½¢å¼ã®æ¤œè¨¼
          if grep -r "op://" . --include="*.env*" --include="*.json" --include="*.yml" --include="*.yaml"; then
            echo "âœ… Found 1Password references - secrets properly externalized"
          fi

          # ç›´æ¥çš„ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå€¤ã®æ¤œå‡º
          if grep -rE "(sk-[a-zA-Z0-9]{48}|[A-Za-z0-9]{64})" . --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" --exclude-dir=node_modules; then
            echo "âŒ Potential hardcoded secrets detected"
            exit 1
          else
            echo "âœ… No hardcoded secrets detected"
          fi

      - name: ğŸ“Š Generate security summary
        run: |
          cat << EOF > security-summary.md
          # ğŸ” Security Monitoring Summary

          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}

          ## âœ… Security Checks Passed
          - TruffleHog secret scanning
          - 1Password reference validation
          - Hardcoded secret detection

          ## ğŸ“Š 1Password Integration Status
          - Secrets properly externalized with op:// references
          - No hardcoded credentials detected
          - Development environment properly configured

          ---
          *Automated security monitoring by BoxLog CI/CD*
          EOF

      - name: ğŸ“Š Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 30