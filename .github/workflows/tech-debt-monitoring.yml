name: ğŸ“Š Technical Debt Monitoring

on:
  # å®šæœŸå®Ÿè¡Œã®ã¿ï¼ˆPRãƒã‚§ãƒƒã‚¯ã¯code-quality.ymlã«çµ±åˆï¼‰
  schedule:
    # æ¯æ—¥AM 10:00 (UTC) ã«å®Ÿè¡Œ
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      full_analysis:
        description: 'Run full technical debt analysis'
        required: false
        default: 'true'
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  tech-debt-analysis:
    name: ğŸ” Technical Debt Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Setup ESLint plugins
        run: npm run eslint:setup

      - name: ğŸ“Š Generate technical debt report
        id: debt-analysis
        run: |
          mkdir -p reports
          npm run debt:report > debt-analysis-output.txt 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ“„ Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: technical-debt-reports
          path: |
            reports/
            debt-analysis-output.txt
          retention-days: 30

      - name: ğŸ“ˆ Extract metrics for PR comment
        if: github.event_name == 'pull_request'
        id: extract-metrics
        run: |
          if [ -f "reports/tech-debt.json" ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
            
            # JSONã‹ã‚‰ä¸»è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æŠ½å‡º
            TOTAL_ERRORS=$(jq -r '.summary.totalErrors' reports/tech-debt.json)
            TOTAL_WARNINGS=$(jq -r '.summary.totalWarnings' reports/tech-debt.json)
            THEME_VIOLATIONS=$(jq -r '.summary.themeViolations' reports/tech-debt.json)
            COMPLIANCE_ISSUES=$(jq -r '.summary.complianceIssues' reports/tech-debt.json)
            OVERALL_SCORE=$(jq -r '.summary.overallScore' reports/tech-debt.json)
            
            echo "total_errors=$TOTAL_ERRORS" >> $GITHUB_OUTPUT
            echo "total_warnings=$TOTAL_WARNINGS" >> $GITHUB_OUTPUT
            echo "theme_violations=$THEME_VIOLATIONS" >> $GITHUB_OUTPUT
            echo "compliance_issues=$COMPLIANCE_ISSUES" >> $GITHUB_OUTPUT
            echo "overall_score=$OVERALL_SCORE" >> $GITHUB_OUTPUT
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¬ Comment PR with technical debt analysis
        if: github.event_name == 'pull_request' && steps.extract-metrics.outputs.report_exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const totalErrors = ${{ steps.extract-metrics.outputs.total_errors }};
            const totalWarnings = ${{ steps.extract-metrics.outputs.total_warnings }};
            const themeViolations = ${{ steps.extract-metrics.outputs.theme_violations }};
            const complianceIssues = ${{ steps.extract-metrics.outputs.compliance_issues }};
            const overallScore = ${{ steps.extract-metrics.outputs.overall_score }};
            
            // ã‚¹ã‚³ã‚¢ã«åŸºã¥ãè©•ä¾¡
            let scoreEmoji = 'ğŸ”´';
            let scoreColor = 'red';
            if (overallScore >= 80) {
              scoreEmoji = 'ğŸŸ¢';
              scoreColor = 'brightgreen';
            } else if (overallScore >= 60) {
              scoreEmoji = 'ğŸŸ¡';
              scoreColor = 'yellow';
            }
            
            const comment = `## ğŸ“Š Technical Debt Analysis Results
            
            ### ğŸ¥ Overall Health Score: ${scoreEmoji} ${overallScore}/100
            
            ![Score](https://img.shields.io/badge/Score-${overallScore}%2F100-${scoreColor})
            
            ### ğŸ“ˆ Detailed Metrics
            
            | Category | Count | Status |
            |----------|-------|--------|
            | ğŸ”´ **ESLint Errors** | ${totalErrors} | ${totalErrors === 0 ? 'âœ… Good' : 'âš ï¸ Needs Attention'} |
            | ğŸŸ¡ **ESLint Warnings** | ${totalWarnings} | ${totalWarnings < 10 ? 'âœ… Good' : totalWarnings < 50 ? 'âš ï¸ Moderate' : 'ğŸ”´ High'} |
            | ğŸ¨ **Theme Violations** | ${themeViolations} | ${themeViolations === 0 ? 'âœ… Perfect' : themeViolations < 5 ? 'âš ï¸ Minor' : 'ğŸ”´ Major'} |
            | ğŸ”’ **Compliance Issues** | ${complianceIssues} | ${complianceIssues === 0 ? 'âœ… Compliant' : 'ğŸ”´ Critical'} |
            
            ### ğŸ’¡ Quick Actions
            
            ${totalErrors > 0 ? '- ğŸ”´ **Priority:** Fix ESLint errors before merging' : ''}
            ${complianceIssues > 0 ? '- ğŸ”’ **Critical:** Address compliance issues immediately' : ''}
            ${themeViolations > 10 ? '- ğŸ¨ **Recommended:** Review theme system usage' : ''}
            ${totalWarnings > 20 ? '- ğŸŸ¡ **Suggested:** Consider addressing high warning count' : ''}
            
            ### ğŸ”— Resources
            
            - ğŸ“Š [Full Technical Debt Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - ğŸ› ï¸ Run locally: \`npm run debt:analyze\`
            - ğŸ“‹ TODO Analysis: \`npm run todo:check\`
            
            ---
            
            ${overallScore >= 80 ? 'ğŸ‰ **Excellent code quality!** Keep up the great work!' : 
              overallScore >= 60 ? 'ğŸ‘ **Good code quality** with room for improvement.' : 
              'âš ï¸ **Code quality needs attention.** Please review the issues above.'}
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes('ğŸ“Š Technical Debt Analysis Results')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: âŒ Fail if critical issues found
        if: steps.extract-metrics.outputs.total_errors > 0 || steps.extract-metrics.outputs.compliance_issues > 0
        run: |
          echo "âŒ Critical technical debt issues found!"
          echo "ESLint Errors: ${{ steps.extract-metrics.outputs.total_errors }}"
          echo "Compliance Issues: ${{ steps.extract-metrics.outputs.compliance_issues }}"
          exit 1

  debt-dashboard-update:
    name: ğŸ“ˆ Update Debt Dashboard
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'schedule'
    needs: tech-debt-analysis
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Setup ESLint plugins
        run: npm run eslint:setup

      - name: ğŸ“Š Generate comprehensive report
        run: |
          mkdir -p reports
          npm run debt:analyze

      - name: ğŸ“ˆ Update trend data
        run: |
          # ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€åˆ†æ
          if [ -f "reports/tech-debt-trends.json" ]; then
            echo "ğŸ“ˆ Trend analysis available"
            
            # æœ€æ–°ã¨å‰å›ã®ã‚¹ã‚³ã‚¢æ¯”è¼ƒ
            CURRENT_SCORE=$(jq -r '.entries[-1].overallScore' reports/tech-debt-trends.json)
            PREVIOUS_SCORE=$(jq -r '.entries[-2].overallScore // 0' reports/tech-debt-trends.json)
            
            echo "Current Score: $CURRENT_SCORE"
            echo "Previous Score: $PREVIOUS_SCORE"
            
            # ã‚¹ã‚³ã‚¢å¤‰åŒ–ã®è¨ˆç®—
            if [ "$PREVIOUS_SCORE" != "0" ] && [ "$PREVIOUS_SCORE" != "null" ]; then
              SCORE_CHANGE=$(echo "$CURRENT_SCORE - $PREVIOUS_SCORE" | bc -l)
              echo "Score Change: $SCORE_CHANGE"
              
              # å¤§ããªå¤‰åŒ–ãŒã‚ã£ãŸå ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆ
              if (( $(echo "$SCORE_CHANGE < -10" | bc -l) )); then
                echo "ğŸš¨ Significant quality degradation detected!"
                echo "score_degradation=true" >> $GITHUB_ENV
              elif (( $(echo "$SCORE_CHANGE > 10" | bc -l) )); then
                echo "ğŸ‰ Significant quality improvement detected!"
                echo "score_improvement=true" >> $GITHUB_ENV
              fi
            fi
          fi

      - name: ğŸš¨ Create quality degradation issue
        if: env.score_degradation == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Code Quality Degradation Alert - ${new Date().toISOString().split('T')[0]}`,
              body: `## ğŸš¨ Code Quality Alert
              
              The technical debt monitoring system has detected a significant degradation in code quality.
              
              ### ğŸ“Š Details
              
              - **Detection Time:** ${new Date().toISOString()}
              - **Trigger:** Automated monitoring
              - **Severity:** High
              
              ### ğŸ” Investigation Required
              
              Please review the latest technical debt report and identify the root cause of the quality degradation.
              
              ### ğŸ“‹ Action Items
              
              - [ ] Review recent commits for quality issues
              - [ ] Check ESLint error trends
              - [ ] Verify compliance issues
              - [ ] Update development practices if needed
              
              ### ğŸ”— Resources
              
              - [Technical Debt Report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              - [Quality Guidelines](./docs/QUALITY_GUIDELINES.md)
              
              ---
              
              ğŸ¤– This issue was automatically created by the Technical Debt Monitoring System.
              `,
              labels: ['technical-debt', 'quality', 'urgent', 'automated']
            });

      - name: ğŸ‰ Celebrate quality improvement
        if: env.score_improvement == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // å“è³ªæ”¹å–„ã‚’celebrateï¼ˆPRã‚„issueã«ã‚³ãƒ¡ãƒ³ãƒˆã€Slackã¸ã®é€šçŸ¥ãªã©ï¼‰
            console.log('ğŸ‰ Code quality has significantly improved!');

  historical-analysis:
    name: ğŸ“š Historical Trend Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“Š Generate monthly summary
        run: |
          # æœˆæ¬¡ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
          echo "ğŸ“Š Generating monthly technical debt summary..."
          
          # ä»Šå¾Œå®Ÿè£…: æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½
          echo "Monthly summary generation - Coming soon"

      - name: ğŸ“ˆ Commit trend data
        if: github.event_name == 'schedule'
        run: |
          # ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚ŒãŸå ´åˆã€ã‚³ãƒŸãƒƒãƒˆ
          if [ -f "reports/tech-debt-trends.json" ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            
            # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if ! git diff --quiet reports/tech-debt-trends.json; then
              git add reports/tech-debt-trends.json
              git commit -m "ğŸ“Š Update technical debt trends data [skip ci]"
              git push
            fi
          fi