name: üìä Weekly Performance Report

# ÈÄ±Ê¨°„Åß„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„É¨„Éù„Éº„Éà„ÇíÁîüÊàê„Åó„ÄÅIssue„Å´ÊäïÁ®ø
on:
  schedule:
    # ÊØéÈÄ±ÊúàÊõúÊó• 9:00 JST (0:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch: # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

env:
  NODE_VERSION: '20'

permissions:
  contents: read
  issues: write

jobs:
  performance-report:
    name: üìä Generate Performance Report
    runs-on: ubuntu-latest
    environment: development
    timeout-minutes: 20
    steps:
      - name: üì• Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üî® Build Next.js
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: ‚ö° Run Lighthouse CI (5 runs for accuracy)
        run: npm run perf:lighthouse
        continue-on-error: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          LHCI_NUMBER_OF_RUNS: '5'

      - name: üìä Upload Lighthouse reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: weekly-lighthouse-${{ github.run_number }}
          path: .lighthouseci
          retention-days: 90

      - name: üìù Create Weekly Report Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const date = new Date().toISOString().split('T')[0];
            let body = `# üìä Weekly Performance Report - ${date}\n\n`;

            // LighthouseÁµêÊûú„ÇíË™≠„ÅøÂèñ„Çä
            try {
              const lhciDir = '.lighthouseci';
              const files = fs.readdirSync(lhciDir);
              const manifestFile = files.find(f => f.startsWith('manifest'));

              if (manifestFile) {
                const manifest = JSON.parse(fs.readFileSync(path.join(lhciDir, manifestFile), 'utf8'));

                // Âπ≥Âùá„Çπ„Ç≥„Ç¢„ÇíË®àÁÆó
                const scores = { performance: 0, accessibility: 0, 'best-practices': 0, seo: 0 };
                let count = 0;

                manifest.forEach(result => {
                  if (result && result.summary) {
                    Object.keys(scores).forEach(key => {
                      scores[key] += result.summary[key] || 0;
                    });
                    count++;
                  }
                });

                if (count > 0) {
                  Object.keys(scores).forEach(key => {
                    scores[key] = Math.round((scores[key] / count) * 100);
                  });

                  body += '## Lighthouse Scores (Average of 5 runs)\n\n';
                  body += '| Category | Score | Status |\n';
                  body += '|----------|-------|--------|\n';
                  body += `| Performance | ${scores.performance} | ${scores.performance >= 90 ? '‚úÖ' : '‚ö†Ô∏è'} |\n`;
                  body += `| Accessibility | ${scores.accessibility} | ${scores.accessibility >= 95 ? '‚úÖ' : '‚ö†Ô∏è'} |\n`;
                  body += `| Best Practices | ${scores['best-practices']} | ${scores['best-practices'] >= 90 ? '‚úÖ' : '‚ö†Ô∏è'} |\n`;
                  body += `| SEO | ${scores.seo} | ${scores.seo >= 95 ? '‚úÖ' : '‚ö†Ô∏è'} |\n`;
                  body += '\n';

                  // ÁõÆÊ®ôÂÄ§„Å®„ÅÆÊØîËºÉ
                  body += '## Target Comparison\n\n';
                  body += '| Metric | Target | Status |\n';
                  body += '|--------|--------|--------|\n';
                  body += `| Performance ‚â• 90 | ${scores.performance >= 90 ? '‚úÖ Met' : '‚ùå Not Met'} |\n`;
                  body += `| Accessibility ‚â• 95 | ${scores.accessibility >= 95 ? '‚úÖ Met' : '‚ùå Not Met'} |\n`;
                  body += '\n';

                  // „Ç¢„ÇØ„Ç∑„Éß„É≥„Ç¢„Ç§„ÉÜ„É†
                  const needsAction = scores.performance < 90 || scores.accessibility < 95;
                  if (needsAction) {
                    body += '## ‚ö†Ô∏è Action Required\n\n';
                    if (scores.performance < 90) {
                      body += '- [ ] Investigate Performance score degradation\n';
                    }
                    if (scores.accessibility < 95) {
                      body += '- [ ] Review Accessibility issues\n';
                    }
                    body += '\n';
                  }
                }
              }
            } catch (e) {
              body += '‚ùå Failed to parse Lighthouse results\n\n';
              body += `Error: ${e.message}\n`;
            }

            body += '---\n';
            body += `üìä [View detailed report in Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n`;
            body += '\n_Generated automatically by Weekly Performance Report workflow_';

            // Issue„Çí‰ΩúÊàê
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üìä Weekly Performance Report - ${date}`,
              body: body,
              labels: ['performance', 'automated']
            });
