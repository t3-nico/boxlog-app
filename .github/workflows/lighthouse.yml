name: âš¡ Lighthouse CI (Post-merge)

# mainãƒãƒ¼ã‚¸å¾Œã«æœ¬ç•ªURLã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ¸¬å®š
on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

# åŒã˜ãƒ–ãƒ©ãƒ³ãƒã§è¤‡æ•°å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã€å¤ã„å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: æœ€å°æ¨©é™ã®åŸå‰‡
permissions:
  contents: read

jobs:
  lighthouse:
    name: âš¡ Lighthouse CI
    runs-on: ubuntu-latest
    environment: development
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: âš¡ Run Lighthouse CI
        run: npm run perf:lighthouse
        continue-on-error: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          LHCI_BUILD_CONTEXT__CURRENT_BRANCH: ${{ github.ref_name }}
          # mainãƒ–ãƒ©ãƒ³ãƒã¯3å›ï¼ˆç²¾åº¦é‡è¦–ï¼‰
          LHCI_NUMBER_OF_RUNS: '3'

      - name: ğŸ“Š Upload Lighthouse reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: lighthouse-reports-${{ github.sha }}
          path: .lighthouseci
          retention-days: 30
