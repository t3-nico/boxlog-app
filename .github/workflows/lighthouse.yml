name: âš¡ Lighthouse CI

# PRã¨main pushã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚’æ¸¬å®š
# - PRæ™‚: 1å›žå®Ÿè¡Œï¼ˆé«˜é€ŸåŒ–ï¼‰ã€è­¦å‘Šã‚³ãƒ¡ãƒ³ãƒˆ
# - main push: 3å›žå®Ÿè¡Œï¼ˆç²¾åº¦é‡è¦–ï¼‰
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

# åŒã˜ãƒ–ãƒ©ãƒ³ãƒã§è¤‡æ•°å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã€å¤ã„å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: æœ€å°æ¨©é™ã®åŽŸå‰‡
permissions:
  contents: read
  pull-requests: write # PRã‚³ãƒ¡ãƒ³ãƒˆç”¨

jobs:
  lighthouse:
    name: âš¡ Lighthouse CI
    runs-on: ubuntu-latest
    environment: development
    timeout-minutes: 15
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”¨ Build Next.js
        run: npm run build
        env:
          # ãƒ“ãƒ«ãƒ‰ã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°ï¼ˆãƒ€ãƒŸãƒ¼å€¤ã§OKï¼‰
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://dummy.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'dummy-key' }}

      - name: âš¡ Run Lighthouse CI
        run: npm run perf:lighthouse
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          LHCI_BUILD_CONTEXT__CURRENT_BRANCH: ${{ github.ref_name }}
          # PR: 1å›žï¼ˆé«˜é€ŸåŒ–ï¼‰ã€main: 3å›žï¼ˆç²¾åº¦é‡è¦–ï¼‰
          LHCI_NUMBER_OF_RUNS: ${{ github.event_name == 'pull_request' && '1' || '3' }}

      - name: ðŸ“Š Upload Lighthouse reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: lighthouse-reports-${{ github.sha }}
          path: .lighthouseci
          retention-days: 30

      - name: ðŸ’¬ Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Lighthouseçµæžœã‚’èª­ã¿å–ã‚Š
            const lhciDir = '.lighthouseci';
            let summary = '## âš¡ Lighthouse CI Results\n\n';

            try {
              const files = fs.readdirSync(lhciDir);
              const manifestFile = files.find(f => f.startsWith('manifest'));

              if (manifestFile) {
                const manifest = JSON.parse(fs.readFileSync(path.join(lhciDir, manifestFile), 'utf8'));
                const result = manifest[0];

                if (result && result.summary) {
                  const scores = result.summary;
                  summary += '| Category | Score |\n';
                  summary += '|----------|-------|\n';
                  summary += `| Performance | ${Math.round(scores.performance * 100)} |\n`;
                  summary += `| Accessibility | ${Math.round(scores.accessibility * 100)} |\n`;
                  summary += `| Best Practices | ${Math.round(scores['best-practices'] * 100)} |\n`;
                  summary += `| SEO | ${Math.round(scores.seo * 100)} |\n`;
                  summary += '\n';

                  // è­¦å‘Šè¡¨ç¤º
                  if (scores.performance < 0.9) {
                    summary += 'âš ï¸ **Warning**: Performance score is below 90\n';
                  }
                  if (scores.accessibility < 0.95) {
                    summary += 'âš ï¸ **Warning**: Accessibility score is below 95\n';
                  }
                }
              }
            } catch (e) {
              summary += 'âŒ Failed to parse Lighthouse results\n';
            }

            summary += '\nðŸ“Š [View full report in Artifacts](../actions/runs/' + context.runId + ')';

            // PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
