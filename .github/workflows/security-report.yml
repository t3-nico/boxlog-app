name: ğŸ“Š Weekly Security Report

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 0:00 UTCï¼ˆæ—¥æœ¬æ™‚é–“ 9:00ï¼‰
    - cron: '0 0 * * 1'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  NODE_VERSION: '18'

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: æœ€å°æ¨©é™ã®åŸå‰‡
permissions:
  contents: read          # ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š
  issues: write           # é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’IssueåŒ–
  pull-requests: read     # PRé–¢é€£æƒ…å ±ã®å–å¾—

jobs:
  generate-report:
    name: ğŸ“Š Generate Security Report
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“Š Generate security report
        run: npm run security:report

      - name: ğŸ“¤ Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.run_number }}
          path: reports/security/*.md
          retention-days: 90

      - name: ğŸ“ Create Issue with Report Summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
            const reportsDir = 'reports/security';
            const files = fs.readdirSync(reportsDir);
            const latestReport = files
              .filter(f => f.startsWith('security-report-'))
              .sort()
              .reverse()[0];

            if (!latestReport) {
              console.log('No report found');
              return;
            }

            const reportPath = path.join(reportsDir, latestReport);
            const reportContent = fs.readFileSync(reportPath, 'utf8');

            // ã‚µãƒãƒªãƒ¼ã‚’æŠ½å‡ºï¼ˆæœ€åˆã®1000æ–‡å­— + æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
            const lines = reportContent.split('\n');
            const summaryLines = lines.slice(0, 40);
            const recommendationsIndex = lines.findIndex(l => l.includes('## 7. æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'));
            const recommendations = recommendationsIndex > 0
              ? lines.slice(recommendationsIndex, recommendationsIndex + 20).join('\n')
              : '';

            // Issueã®ä½œæˆï¼ˆæ—¢å­˜ã®weekly reportãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,weekly-report',
              state: 'open',
            });

            const thisWeek = new Date().toISOString().split('T')[0];
            const existingThisWeek = existingIssues.find(
              issue => issue.title.includes(thisWeek)
            );

            if (existingThisWeek) {
              console.log('Weekly report issue already exists');
              return;
            }

            // æ–°è¦Issueä½œæˆ
            const reportBody = [
              '# ğŸ›¡ï¸ Weekly Security Report',
              '',
              summaryLines.join('\n'),
              '',
              recommendations,
              '',
              '---',
              '',
              `**Full Report**: [Download Artifact](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              '',
              `**Next Report**: ${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}`,
              '',
              '<sub>ğŸ¤– Automated weekly security report</sub>'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ›¡ï¸ Weekly Security Report - ${thisWeek}`,
              labels: ['security', 'weekly-report', 'documentation'],
              body: reportBody
            });

      - name: ğŸ’¬ Notify on Critical Issues
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Security Report Generation Failed',
              labels: ['security', 'bug', 'P0-critical'],
              body: `## ğŸš¨ Security Report Generation Failed

**Workflow Run**: [${context.runId}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

**Date**: ${new Date().toISOString()}

**Action Required**: Investigate why the security report generation failed.

<sub>ğŸ¤– Automated security alert</sub>
              `
            });
