name: 'ğŸ“Š Weekly Quality Report'

# é€±æ¬¡å“è³ªãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ
# æ¯é€±æœˆæ›œæ—¥ 9:00 JSTï¼ˆæ—¥æ›œæ—¥ 24:00 UTCï¼‰ã«å®Ÿè¡Œ

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 9:00 JSTï¼ˆæ—¥æ›œæ—¥ 24:00 UTCï¼‰
    - cron: '0 0 * * 1'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      create_issues:
        description: 'æ”¹å–„Issueä½œæˆ'
        required: false
        default: 'true'
        type: boolean
      send_notifications:
        description: 'Slacké€šçŸ¥é€ä¿¡'
        required: false
        default: 'true'
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  quality-analysis:
    name: 'å“è³ªåˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write  # Issueä½œæˆæ¨©é™
      pull-requests: read

    steps:
      - name: 'ğŸ“¥ Repository Checkout'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å±¥æ­´æ¯”è¼ƒã®ãŸã‚å…¨å±¥æ­´å–å¾—

      - name: 'ğŸŸ¢ Node.js Setup'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 'ğŸ“¦ Dependencies Installation'
        run: npm ci

      - name: 'ğŸ” ESLint Analysis'
        run: |
          echo "ğŸ“Š ESLintåˆ†æé–‹å§‹..."
          npm run lint --silent > eslint-report.txt 2>&1 || true
          echo "ESLintåˆ†æå®Œäº†"
        continue-on-error: true

      - name: 'ğŸ”· TypeScript Analysis'
        run: |
          echo "ğŸ“Š TypeScriptåˆ†æé–‹å§‹..."
          npm run typecheck > typescript-report.txt 2>&1 || true
          echo "TypeScriptåˆ†æå®Œäº†"
        continue-on-error: true

      - name: 'ğŸ§ª Test Coverage Analysis'
        run: |
          echo "ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æé–‹å§‹..."
          npm run test:coverage > coverage-report.txt 2>&1 || true
          echo "ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æå®Œäº†"
        continue-on-error: true

      - name: 'ğŸ“Š Quality Report Generation'
        run: |
          echo "ğŸ“Š å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹..."
          npm run quality:report
          echo "å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
        continue-on-error: true

      - name: 'ğŸ¯ Improvement Suggestions'
        if: ${{ github.event.inputs.create_issues != 'false' }}
        run: |
          echo "ğŸ¯ æ”¹å–„ææ¡ˆã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œ..."
          npm run improvement:suggest --skip-slack
          echo "æ”¹å–„ææ¡ˆå®Œäº†"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: 'ğŸ“‹ Quality Report Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports
          path: |
            reports/quality/
            eslint-report.txt
            typescript-report.txt
            coverage-report.txt
          retention-days: 30

      - name: 'ğŸ“Š Quality Summary Comment'
        if: success()
        run: |
          echo "ğŸ“Š å“è³ªã‚µãƒãƒªãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆ..."

          # æœ€æ–°ã®å“è³ªãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰æƒ…å ±æŠ½å‡º
          LATEST_REPORT=$(ls -t reports/quality/quality-report-*.json | head -1)

          if [ -f "$LATEST_REPORT" ]; then
            SCORE=$(jq -r '.score' "$LATEST_REPORT")
            GRADE=$(jq -r '.grade' "$LATEST_REPORT")
            STATUS=$(jq -r '.status' "$LATEST_REPORT")
            ESLINT_ERRORS=$(jq -r '.codeQuality.eslint.errors' "$LATEST_REPORT")
            TS_ERRORS=$(jq -r '.codeQuality.typescript.errors' "$LATEST_REPORT")
            COVERAGE=$(jq -r '.testing.coverage.lines' "$LATEST_REPORT")
            TODO_COUNT=$(jq -r '.technicalDebt.todoCount' "$LATEST_REPORT")
            RECOMMENDATIONS=$(jq -r '.recommendations | length' "$LATEST_REPORT")

            # GitHub Issueã«ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆï¼ˆæœ€æ–°ã®Issueã¾ãŸã¯å°‚ç”¨Issueï¼‰
            cat > quality-summary.md << EOF
          ## ğŸ“Š é€±æ¬¡å“è³ªãƒ¬ãƒãƒ¼ãƒˆ - $(date '+%Yå¹´%mæœˆ%dæ—¥')

          ### ğŸ“ˆ ç·åˆè©•ä¾¡
          - **ã‚¹ã‚³ã‚¢**: ${SCORE}/100ç‚¹
          - **ã‚°ãƒ¬ãƒ¼ãƒ‰**: ${GRADE}
          - **çŠ¶æ…‹**: ${STATUS}

          ### ğŸ” è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹
          - **ESLintã‚¨ãƒ©ãƒ¼**: ${ESLINT_ERRORS}ä»¶
          - **TypeScriptã‚¨ãƒ©ãƒ¼**: ${TS_ERRORS}ä»¶
          - **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: ${COVERAGE}%
          - **æŠ€è¡“çš„è² å‚µ**: ${TODO_COUNT}å€‹ã®TODO

          ### ğŸ’¡ æ”¹å–„ææ¡ˆ
          - **ææ¡ˆæ•°**: ${RECOMMENDATIONS}ä»¶

          ### ğŸ”— è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
          - [å“è³ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://your-app-url.vercel.app/quality-dashboard)
          - [è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *è‡ªå‹•ç”Ÿæˆ - GitHub Actionsé€±æ¬¡å®Ÿè¡Œ*
          EOF

            # Issue #356ã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
            gh issue comment 356 --body-file quality-summary.md
          else
            echo "å“è³ªãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: 'ğŸ“² Slack Notification'
        if: ${{ github.event.inputs.send_notifications != 'false' && success() }}
        run: |
          echo "ğŸ“² Slacké€šçŸ¥æº–å‚™..."

          # Slacké€šçŸ¥ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆå®Ÿéš›ã®é€ä¿¡ã¯Webhook URLè¨­å®šæ™‚ï¼‰
          LATEST_REPORT=$(ls -t reports/quality/quality-report-*.json | head -1)

          if [ -f "$LATEST_REPORT" ]; then
            SCORE=$(jq -r '.score' "$LATEST_REPORT")
            GRADE=$(jq -r '.grade' "$LATEST_REPORT")
            STATUS=$(jq -r '.status' "$LATEST_REPORT")

            cat > slack-payload.json << EOF
          {
            "text": "ğŸ“Š BoxLogé€±æ¬¡å“è³ªãƒ¬ãƒãƒ¼ãƒˆ",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ğŸ“Š BoxLog é€±æ¬¡å“è³ªãƒ¬ãƒãƒ¼ãƒˆ"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ã‚¹ã‚³ã‚¢:* ${SCORE}/100 (${GRADE})"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*çŠ¶æ…‹:* ${STATUS}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹>"
                }
              }
            ]
          }
          EOF

            echo "Slacké€šçŸ¥ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†"

            # å®Ÿéš›ã®Slacké€ä¿¡ï¼ˆSLACK_WEBHOOK_URLè¨­å®šæ™‚ï¼‰
            if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
              curl -X POST -H 'Content-type: application/json' \
                --data @slack-payload.json \
                "${{ secrets.SLACK_WEBHOOK_URL }}"
              echo "Slacké€šçŸ¥é€ä¿¡å®Œäº†"
            else
              echo "SLACK_WEBHOOK_URLæœªè¨­å®šã®ãŸã‚ã€é€šçŸ¥ãƒ‡ãƒ¼ã‚¿ã®ã¿ç”Ÿæˆ"
            fi
          fi
        continue-on-error: true

      - name: 'ğŸ† Success Summary'
        if: success()
        run: |
          echo "ğŸ‰ é€±æ¬¡å“è³ªãƒ¬ãƒãƒ¼ãƒˆå®Ÿè¡Œå®Œäº†!"
          echo "ğŸ“Š å“è³ªãƒ¬ãƒãƒ¼ãƒˆ: ç”Ÿæˆæ¸ˆã¿"
          echo "ğŸ¯ æ”¹å–„ææ¡ˆ: å‡¦ç†æ¸ˆã¿"
          echo "ğŸ“² é€šçŸ¥: é€ä¿¡æ¸ˆã¿"
          echo ""
          echo "ğŸ”— æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
          echo "1. å“è³ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§çµæœç¢ºèª"
          echo "2. æ”¹å–„Issueã®ç¢ºèªãƒ»å¯¾å¿œ"
          echo "3. æ¬¡é€±ã®ç›®æ¨™è¨­å®š"

  # é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æï¼ˆæœˆæ¬¡ï¼‰
  monthly-trend-analysis:
    name: 'ğŸ“ˆ æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ'
    runs-on: ubuntu-latest
    needs: quality-analysis
    if: ${{ github.event.schedule && github.event.schedule == '0 0 * * 1' && format('{0}', github.event.repository.pushed_at) == format('{0}', github.event.head_commit.timestamp) }}

    steps:
      - name: 'ğŸ“¥ Repository Checkout'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'ğŸŸ¢ Node.js Setup'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 'ğŸ“¦ Dependencies Installation'
        run: npm ci

      - name: 'ğŸ“ˆ Trend Analysis'
        run: |
          echo "ğŸ“ˆ æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æé–‹å§‹..."

          # éå»30æ—¥ã®å“è³ªãƒ‡ãƒ¼ã‚¿åˆ†æ
          # å®Ÿè£…äºˆå®š: æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

          echo "æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æå®Œäº†"
        continue-on-error: true