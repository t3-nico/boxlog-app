name: ğŸ·ï¸ Naming Convention Dictionary Check

on:
  push:
    branches: [dev, main]
    paths:
      - 'src/**/*.{ts,tsx,js,jsx}'
      - '.eslint/**/*'
      - 'src/config/naming-conventions/**/*'
  pull_request:
    branches: [dev, main]
    paths:
      - 'src/**/*.{ts,tsx,js,jsx}'
      - '.eslint/**/*'
      - 'src/config/naming-conventions/**/*'

jobs:
  naming-convention-check:
    name: ğŸ“ Naming Convention Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          npm install -g glob

      - name: ğŸ” Run Naming Convention Analysis
        id: naming-analysis
        run: |
          echo "ğŸ·ï¸ BoxLog App å‘½åè¦å‰‡è¾æ›¸ãƒã‚§ãƒƒã‚¯é–‹å§‹..."
          npm run naming:analyze > naming-analysis.log 2>&1 || true

          # çµæœãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "reports/naming-migration-analysis.json" ]; then
            echo "ANALYSIS_FOUND=true" >> $GITHUB_OUTPUT
            echo "è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
          else
            echo "ANALYSIS_FOUND=false" >> $GITHUB_OUTPUT
            echo "åˆ†æãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: ğŸ“Š Parse Analysis Results
        id: parse-results
        if: steps.naming-analysis.outputs.ANALYSIS_FOUND == 'true'
        run: |
          # JSON ãƒ¬ãƒãƒ¼ãƒˆã®è§£æ
          TOTAL_SUGGESTIONS=$(jq '.summary.totalSuggestions' reports/naming-migration-analysis.json || echo "0")
          TOTAL_FILES=$(jq '.summary.totalFiles' reports/naming-migration-analysis.json || echo "0")

          echo "TOTAL_SUGGESTIONS=$TOTAL_SUGGESTIONS" >> $GITHUB_OUTPUT
          echo "TOTAL_FILES=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "TIMESTAMP=$(jq -r '.timestamp' reports/naming-migration-analysis.json || echo 'N/A')" >> $GITHUB_OUTPUT

          echo "ğŸ“Š åˆ†æçµæœ:"
          echo "  - æ”¹å–„ææ¡ˆæ•°: $TOTAL_SUGGESTIONSä»¶"
          echo "  - å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $TOTAL_FILESä»¶"

      - name: ğŸ“‹ ESLint Naming Rules Check
        id: eslint-naming
        run: |
          echo "ğŸ” ESLint å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ..."
          npm run lint -- --ext .ts,.tsx,.js,.jsx --format json --output-file eslint-naming-report.json || true

          # ESLintçµæœã®è§£æï¼ˆå‘½åé–¢é€£ãƒ«ãƒ¼ãƒ«ã®ã¿ï¼‰
          if [ -f "eslint-naming-report.json" ]; then
            # å‘½åé–¢é€£ã®ã‚¨ãƒ©ãƒ¼æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            NAMING_ERRORS=$(jq '[.[] | .messages[] | select(.ruleId | test("naming|@local/naming"))] | length' eslint-naming-report.json || echo "0")
            echo "NAMING_ERRORS=$NAMING_ERRORS" >> $GITHUB_OUTPUT
            echo "ğŸ“ ESLintå‘½åã‚¨ãƒ©ãƒ¼æ•°: $NAMING_ERRORSä»¶"
          else
            echo "NAMING_ERRORS=0" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ¯ Generate Naming Summary
        id: summary
        run: |
          # ç·åˆã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ
          SUGGESTIONS="${{ steps.parse-results.outputs.TOTAL_SUGGESTIONS || '0' }}"
          ESLINT_ERRORS="${{ steps.eslint-naming.outputs.NAMING_ERRORS || '0' }}"
          TOTAL_ISSUES=$((SUGGESTIONS + ESLINT_ERRORS))

          echo "TOTAL_ISSUES=$TOTAL_ISSUES" >> $GITHUB_OUTPUT

          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
          if [ "$TOTAL_ISSUES" -eq 0 ]; then
            echo "STATUS=âœ… åˆæ ¼" >> $GITHUB_OUTPUT
            echo "STATUS_COLOR=success" >> $GITHUB_OUTPUT
          elif [ "$TOTAL_ISSUES" -le 5 ]; then
            echo "STATUS=âš ï¸ æ³¨æ„" >> $GITHUB_OUTPUT
            echo "STATUS_COLOR=warning" >> $GITHUB_OUTPUT
          else
            echo "STATUS=âŒ è¦æ”¹å–„" >> $GITHUB_OUTPUT
            echo "STATUS_COLOR=failure" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Comment PR Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // åŸºæœ¬æƒ…å ±
            const totalIssues = '${{ steps.summary.outputs.TOTAL_ISSUES }}';
            const status = '${{ steps.summary.outputs.STATUS }}';
            const suggestions = '${{ steps.parse-results.outputs.TOTAL_SUGGESTIONS || "0" }}';
            const eslintErrors = '${{ steps.eslint-naming.outputs.NAMING_ERRORS || "0" }}';
            const affectedFiles = '${{ steps.parse-results.outputs.TOTAL_FILES || "0" }}';

            // è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿
            let detailsSection = '';
            if (fs.existsSync('reports/naming-migration-analysis.json')) {
              try {
                const report = JSON.parse(fs.readFileSync('reports/naming-migration-analysis.json', 'utf8'));

                if (report.results && report.results.length > 0) {
                  detailsSection = '\n## ğŸ“‹ è©³ç´°ãªæ”¹å–„ææ¡ˆ\n\n';

                  report.results.slice(0, 5).forEach(result => {
                    detailsSection += `### ğŸ“„ \`${result.file}\`\n\n`;
                    result.suggestions.slice(0, 3).forEach(suggestion => {
                      const icon = suggestion.type === 'forbidden' ? 'ğŸš«' : 'ğŸ’¡';
                      detailsSection += `- ${icon} **L${suggestion.line}**: \`${suggestion.original}\` â†’ \`${suggestion.suggested}\`\n`;
                      detailsSection += `  - ç†ç”±: ${suggestion.reason}\n\n`;
                    });
                  });

                  if (report.results.length > 5) {
                    detailsSection += `\n*ãã®ä»– ${report.results.length - 5} ãƒ•ã‚¡ã‚¤ãƒ«ã«æ”¹å–„ææ¡ˆãŒã‚ã‚Šã¾ã™*\n`;
                  }
                } else {
                  detailsSection = '\nâœ… **æ”¹å–„ææ¡ˆã¯ã‚ã‚Šã¾ã›ã‚“** - ã‚³ãƒ¼ãƒ‰ã¯å‘½åè¦å‰‡ã«æº–æ‹ ã—ã¦ã„ã¾ã™ï¼\n';
                }
              } catch (error) {
                detailsSection = '\nâš ï¸ ãƒ¬ãƒãƒ¼ãƒˆã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n';
              }
            }

            const comment = `## ğŸ·ï¸ å‘½åè¦å‰‡è¾æ›¸ãƒã‚§ãƒƒã‚¯çµæœ

            **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${status}

            ### ğŸ“Š ã‚µãƒãƒªãƒ¼
            | é …ç›® | ä»¶æ•° |
            |------|------|
            | ğŸ’¡ æ”¹å–„ææ¡ˆ | ${suggestions}ä»¶ |
            | ğŸ” ESLintå‘½åã‚¨ãƒ©ãƒ¼ | ${eslintErrors}ä»¶ |
            | ğŸ“ å½±éŸ¿ãƒ•ã‚¡ã‚¤ãƒ«æ•° | ${affectedFiles}ä»¶ |
            | ğŸ¯ **åˆè¨ˆå•é¡Œæ•°** | **${totalIssues}ä»¶** |

            ### ğŸ¯ å“è³ªåŸºæº–
            - âœ… **åˆæ ¼**: 0ä»¶
            - âš ï¸ **æ³¨æ„**: 1-5ä»¶ï¼ˆè»½å¾®ãªæ”¹å–„ä½™åœ°ï¼‰
            - âŒ **è¦æ”¹å–„**: 6ä»¶ä»¥ä¸Šï¼ˆå¯¾å¿œæ¨å¥¨ï¼‰

            ${detailsSection}

            ### ğŸ› ï¸ æ”¹å–„æ–¹æ³•

            1. **è‡ªå‹•ä¿®æ­£ã®å®Ÿè¡Œ**:
               \`\`\`bash
               npm run lint:fix
               npm run naming:migrate:apply
               \`\`\`

            2. **è©³ç´°åˆ†æã®ç¢ºèª**:
               \`\`\`bash
               npm run naming:analyze
               \`\`\`

            3. **VS Code Snippetsæ´»ç”¨**:
               - \`rfc-domain\` - ãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨èªå¯¾å¿œReactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
               - \`hook-domain\` - ãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨èªå¯¾å¿œã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
               - \`type-domain\` - ãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨èªå¯¾å¿œTypeScriptå‹

            ---
            ğŸ¤– *BoxLog App å‘½åè¦å‰‡è¾æ›¸ã‚·ã‚¹ãƒ†ãƒ  - çµ±ä¸€å‘½åè¦å‰‡ã«ã‚ˆã‚‹å“è³ªå‘ä¸Š*`;

            // PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(comment =>
              comment.body.includes('ğŸ·ï¸ å‘½åè¦å‰‡è¾æ›¸ãƒã‚§ãƒƒã‚¯çµæœ')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: ğŸ“„ Upload Analysis Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: naming-analysis-reports
          path: |
            reports/naming-migration-analysis.json
            eslint-naming-report.json
            naming-analysis.log
          retention-days: 30

      - name: ğŸ¯ Set Check Status
        if: always()
        run: |
          TOTAL_ISSUES="${{ steps.summary.outputs.TOTAL_ISSUES }}"

          if [ "$TOTAL_ISSUES" -eq 0 ]; then
            echo "âœ… å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯: å®Œå…¨åˆæ ¼ (å•é¡Œãªã—)"
          elif [ "$TOTAL_ISSUES" -le 5 ]; then
            echo "âš ï¸ å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯: è»½å¾®ãªæ”¹å–„ä½™åœ°ã‚ã‚Š ($TOTAL_ISSUESä»¶)"
            # æ³¨æ„ãƒ¬ãƒ™ãƒ«ã§ã¯ç¶™ç¶šå®Ÿè¡Œ
          else
            echo "âŒ å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯: è¦æ”¹å–„ ($TOTAL_ISSUESä»¶)"
            echo "æ”¹å–„ãŒæ¨å¥¨ã•ã‚Œã¾ã™ãŒã€ãƒ“ãƒ«ãƒ‰ã¯ç¶™ç¶šã—ã¾ã™"
            # ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«ã§ã‚‚ç¶™ç¶šå®Ÿè¡Œï¼ˆæƒ…å ±æä¾›ã®ã¿ï¼‰
          fi

  naming-enforcement-check:
    name: ğŸ”’ Naming Enforcement Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ” Validate Dictionary Files
        run: |
          echo "ğŸ” å‘½åè¦å‰‡è¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼..."

          # è¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ ! -f "src/config/naming-conventions/dictionary.json" ]; then
            echo "âŒ å‘½åè¦å‰‡è¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # JSONæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          if ! jq empty src/config/naming-conventions/dictionary.json; then
            echo "âŒ è¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã®JSONæ§‹æ–‡ã‚¨ãƒ©ãƒ¼"
            exit 1
          fi

          # å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç¢ºèª
          DOMAIN_TERMS=$(jq '.domainTerms | length' src/config/naming-conventions/dictionary.json)
          FORBIDDEN_TERMS=$(jq '.forbiddenTerms | length' src/config/naming-conventions/dictionary.json)
          NAMING_PATTERNS=$(jq '.namingPatterns | length' src/config/naming-conventions/dictionary.json)

          echo "ğŸ“Š è¾æ›¸çµ±è¨ˆ:"
          echo "  - ãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨èª: $DOMAIN_TERMSå€‹"
          echo "  - ç¦æ­¢ç”¨èª: $FORBIDDEN_TERMSå€‹"
          echo "  - å‘½åãƒ‘ã‚¿ãƒ¼ãƒ³: $NAMING_PATTERNSå€‹"

          # æœ€å°è¦ä»¶ãƒã‚§ãƒƒã‚¯
          if [ "$DOMAIN_TERMS" -lt 50 ]; then
            echo "âš ï¸ ãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨èªãŒ50å€‹æœªæº€ã§ã™ (ç¾åœ¨: $DOMAIN_TERMSå€‹)"
          fi

          if [ "$NAMING_PATTERNS" -lt 10 ]; then
            echo "âš ï¸ å‘½åãƒ‘ã‚¿ãƒ¼ãƒ³ãŒ10å€‹æœªæº€ã§ã™ (ç¾åœ¨: $NAMING_PATTERNSå€‹)"
          fi

      - name: ğŸ”§ Validate ESLint Integration
        run: |
          echo "ğŸ”§ ESLintçµ±åˆã®æ¤œè¨¼..."

          # ESLintè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ ! -f ".eslint/configs/naming-conventions.js" ]; then
            echo "âŒ ESLintå‘½åè¦å‰‡è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ ! -f ".eslint/rules/naming-system.js" ]; then
            echo "âš ï¸ ESLintã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

          # ESLintè¨­å®šã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          node -e "require('./.eslint/configs/naming-conventions.js')" || {
            echo "âŒ ESLintå‘½åè¦å‰‡è¨­å®šã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼"
            exit 1
          }

          echo "âœ… ESLintçµ±åˆæ¤œè¨¼å®Œäº†"

      - name: ğŸ“ Validate VS Code Integration
        run: |
          echo "ğŸ“ VS Codeçµ±åˆã®æ¤œè¨¼..."

          # VS Code snippetsãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ ! -f ".vscode/snippets/domain-terms.json" ]; then
            echo "âš ï¸ VS Code snippetsãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          else
            # JSONæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
            if ! jq empty .vscode/snippets/domain-terms.json; then
              echo "âŒ VS Code snippetsãƒ•ã‚¡ã‚¤ãƒ«ã®JSONæ§‹æ–‡ã‚¨ãƒ©ãƒ¼"
              exit 1
            fi

            SNIPPET_COUNT=$(jq 'keys | length' .vscode/snippets/domain-terms.json)
            echo "ğŸ“ VS Code snippetsæ•°: $SNIPPET_COUNTå€‹"
          fi

          echo "âœ… VS Codeçµ±åˆæ¤œè¨¼å®Œäº†"

      - name: âœ… Validation Summary
        run: |
          echo "ğŸ‰ å‘½åè¦å‰‡è¾æ›¸ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼å®Œäº†"
          echo ""
          echo "âœ… ã™ã¹ã¦ã®æ¤œè¨¼é …ç›®ã‚’ã‚¯ãƒªã‚¢:"
          echo "  ğŸ·ï¸ è¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ "
          echo "  ğŸ”§ ESLintçµ±åˆ"
          echo "  ğŸ“ VS Codeçµ±åˆ"
          echo "  ğŸ“Š å“è³ªåŸºæº–æº–æ‹ "