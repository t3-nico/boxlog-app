name: License Compliance Check

on:
  # PRæ™‚ã«å¿…é ˆãƒã‚§ãƒƒã‚¯ï¼ˆãƒãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯å¯èƒ½ï¼‰
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - '.licensrc.json'

  # pushã§ã‚‚å®Ÿè¡Œï¼ˆmain/devä¿è­·ï¼‰
  push:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - '.licensrc.json'
    branches:
      - main
      - dev

  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
  workflow_dispatch:

env:
  NODE_VERSION: '18'

# èª­ã¿å–ã‚Šå°‚ç”¨ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
permissions:
  contents: read
  pull-requests: write  # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ç”¨

jobs:
  license-compliance:
    name: ğŸ”’ Check License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8  # v4.0.2
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” License Compliance Check (Strict)
        id: license_check
        run: |
          echo "## ğŸ”’ License Compliance Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # åŸºæœ¬ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          if npm run license:check 2>&1 | tee /tmp/license-check.log; then
            echo "check_status=passed" >> $GITHUB_OUTPUT
            echo "âœ… **Status**: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All packages use approved licenses." >> $GITHUB_STEP_SUMMARY
          else
            echo "check_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ **Status**: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ Restricted Licenses Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/license-check.log | tail -20 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“Š Generate License Report
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š License Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ã‚µãƒãƒªãƒ¼è¡¨ç¤º
          npm run license:audit | grep -E "â”œâ”€|â””â”€" | head -20 >> $GITHUB_STEP_SUMMARY || true

      - name: ğŸ’¬ Comment on PR (Failure)
        if: steps.license_check.outputs.check_status == 'failed' && github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const logContent = fs.readFileSync('/tmp/license-check.log', 'utf8');

            const comment = `## ğŸ”’ License Compliance Check Failed âŒ

### âš ï¸ Action Required

This PR introduces dependencies with **restricted licenses** that are not approved for use in this project.

### ğŸ“‹ Restricted License Policy

**Prohibited Licenses:**
- âŒ GPL-2.0, GPL-3.0 (Strong copyleft - requires source code disclosure)
- âŒ AGPL-3.0 (Network copyleft - requires SaaS source disclosure)
- âŒ LGPL-2.1, LGPL-3.0 (Weak copyleft - linking restrictions)
- âŒ EUPL-1.1, EUPL-1.2 (European copyleft)
- âŒ CDDL-1.0, EPL-1.0, EPL-2.0 (File-level copyleft)

**Approved Licenses:**
- âœ… MIT, BSD-2-Clause, BSD-3-Clause
- âœ… Apache-2.0, ISC, CC0-1.0
- âœ… MPL-2.0 (with review)

### ğŸ”§ How to Fix

1. **Find Alternative Packages**: Search for packages with MIT/Apache-2.0 licenses
2. **Remove Restricted Packages**: \`npm uninstall <package-name>\`
3. **Request Exception**: Contact legal team if the package is critical

### ğŸ“ Detailed Error Log

<details>
<summary>Click to expand error log</summary>

\`\`\`
${logContent.split('\n').slice(-30).join('\n')}
\`\`\`

</details>

### ğŸ”— Resources

- [LICENSE_COMPLIANCE_PLAN.md](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/legal/LICENSE_COMPLIANCE_PLAN.md)
- [Approved Licenses](.licensrc.json)

---
<sub>ğŸ¤– Automated by License Compliance Check</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: ğŸ’¬ Comment on PR (Success)
        if: steps.license_check.outputs.check_status == 'passed' && github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const comment = `## ğŸ”’ License Compliance Check Passed âœ…

All dependencies use approved licenses. This PR is safe to merge from a licensing perspective.

### âœ… Compliance Status
- No restricted licenses detected
- All packages comply with project license policy

---
<sub>ğŸ¤– Automated by License Compliance Check</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: âŒ Fail if restricted licenses detected
        if: steps.license_check.outputs.check_status == 'failed'
        run: |
          echo "::error::âŒ License compliance check failed"
          echo "::error::Restricted licenses detected in dependencies"
          echo "::error::Please remove packages with GPL/AGPL/LGPL licenses"
          echo "::error::See workflow summary for details"
          exit 1

      - name: âœ… Success
        if: steps.license_check.outputs.check_status == 'passed'
        run: |
          echo "âœ… License compliance check passed"
          echo "All dependencies use approved licenses"
