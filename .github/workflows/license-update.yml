name: ğŸ“„ License Information Auto-Update

on:
  # ä¾å­˜é–¢ä¿‚å¤‰æ›´æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
  push:
    paths:
      - 'package.json'
      - 'package-lock.json'
    branches:
      - dev
      - main

  # PRã§package.jsonå¤‰æ›´æ™‚
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'

  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
  workflow_dispatch:

  # é€±æ¬¡è‡ªå‹•å®Ÿè¡Œï¼ˆæ¯é€±æœˆæ›œæ—¥ 0:00 UTCï¼‰
  schedule:
    - cron: '0 0 * * 1'

env:
  NODE_VERSION: '18'

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: æœ€å°æ¨©é™ã®åŸå‰‡
permissions:
  contents: write        # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆç”¨
  pull-requests: write   # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ç”¨

jobs:
  update-licenses:
    name: ğŸ“„ Update License Information
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8  # v4.0.2
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“„ Generate license information
        run: npm run generate-licenses

      - name: ğŸ”’ License compliance check
        id: compliance_check
        run: |
          npm run license:check || echo "compliance_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: âš ï¸ Compliance failure notification
        if: steps.compliance_check.outputs.compliance_failed == 'true'
        run: |
          echo "::error::âŒ License compliance check failed"
          echo "::error::Some packages use restricted licenses (GPL, AGPL, etc.)"
          echo "::error::Please review license-policy.json and remove restricted packages"
          exit 1

      - name: ğŸ” Check for changes
        id: check_changes
        run: |
          if git diff --quiet public/oss-credits.json public/THIRD_PARTY_NOTICES.txt; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ No license changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ License changes detected"
            git diff --stat public/oss-credits.json public/THIRD_PARTY_NOTICES.txt
          fi

      - name: ğŸ“Š License Statistics
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          echo "## ğŸ“Š License Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- public/oss-credits.json" >> $GITHUB_STEP_SUMMARY
          echo "- public/THIRD_PARTY_NOTICES.txt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          PACKAGE_COUNT=$(jq '. | length' public/oss-credits.json)
          echo "### Statistics:" >> $GITHUB_STEP_SUMMARY
          echo "- Total Packages: ${PACKAGE_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹åˆ†å¸ƒã‚’è¡¨ç¤º
          echo "### License Distribution:" >> $GITHUB_STEP_SUMMARY
          jq -r 'group_by(.license) | map({license: .[0].license, count: length}) | sort_by(-.count) | .[] | "- \(.license): \(.count)"' public/oss-credits.json >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¾ Commit changes
        if: steps.check_changes.outputs.changed == 'true' && github.event_name != 'pull_request'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add public/oss-credits.json public/THIRD_PARTY_NOTICES.txt
          git commit -m "$(cat <<'EOF'
          chore: ä¾å­˜é–¢ä¿‚ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±ã‚’è‡ªå‹•æ›´æ–°

          ğŸ“„ License Information Generator ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆ

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )"
          git push

      - name: ğŸ’¬ Comment on PR
        if: steps.check_changes.outputs.changed == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            const ossCredits = JSON.parse(fs.readFileSync('public/oss-credits.json', 'utf8'));
            const packageCount = ossCredits.length;

            // ãƒ©ã‚¤ã‚»ãƒ³ã‚¹åˆ†å¸ƒã‚’è¨ˆç®—
            const licenseDistribution = ossCredits.reduce((acc, pkg) => {
              acc[pkg.license] = (acc[pkg.license] || 0) + 1;
              return acc;
            }, {});

            const topLicenses = Object.entries(licenseDistribution)
              .sort(([, a], [, b]) => b - a)
              .slice(0, 5)
              .map(([license, count]) => `- ${license}: ${count} packages`)
              .join('\n');

            // ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã‚’å–å¾—
            let complianceStatus = 'âœ… **åˆæ ¼** - ã™ã¹ã¦ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæ‰¿èªæ¸ˆã¿ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã§ã™';
            try {
              execSync('npm run license:check', { encoding: 'utf-8' });
            } catch (error) {
              complianceStatus = 'âŒ **å¤±æ•—** - åˆ¶é™ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
            }

            const commentBody = [
              '## ğŸ“„ License Information Updated',
              '',
              '### ğŸ“Š Statistics',
              `- **Total Packages**: ${packageCount}`,
              '',
              '### ğŸ”’ Compliance Check',
              complianceStatus,
              '',
              '### ğŸ† Top 5 Licenses',
              topLicenses,
              '',
              '### ğŸ“ Generated Files',
              '- `public/oss-credits.json` - Web display data',
              '- `public/THIRD_PARTY_NOTICES.txt` - Apache-2.0 NOTICE files',
              '',
              '### ğŸ”— View Changes',
              'You can view the complete OSS credits at `/legal/oss-credits` after merging this PR.',
              '',
              '---',
              '<sub>ğŸ¤– Generated by License Information Generator</sub>'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

      - name: âœ… No changes
        if: steps.check_changes.outputs.changed == 'false'
        run: |
          echo "âœ… License information is up to date" >> $GITHUB_STEP_SUMMARY
          echo "No changes to public/oss-credits.json or public/THIRD_PARTY_NOTICES.txt" >> $GITHUB_STEP_SUMMARY
