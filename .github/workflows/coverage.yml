name: ğŸ“Š Coverage Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

concurrency:
  group: coverage-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  coverage:
    name: ğŸ“Š Coverage Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run tests with coverage
        run: npm run test:coverage

      - name: ğŸ“Š Extract coverage summary
        id: coverage
        run: |
          # coverage-summary.json ã‹ã‚‰æ•°å€¤ã‚’æŠ½å‡º
          LINES=$(jq '.total.lines.pct' coverage/coverage-summary.json)
          BRANCHES=$(jq '.total.branches.pct' coverage/coverage-summary.json)
          FUNCTIONS=$(jq '.total.functions.pct' coverage/coverage-summary.json)
          STATEMENTS=$(jq '.total.statements.pct' coverage/coverage-summary.json)

          echo "lines=$LINES" >> $GITHUB_OUTPUT
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
          echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT

          # ã‚µãƒãƒªãƒ¼JSONã‚’ä½œæˆï¼ˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆç”¨ï¼‰
          echo "{\"lines\": $LINES, \"branches\": $BRANCHES, \"functions\": $FUNCTIONS, \"statements\": $STATEMENTS}" > coverage/summary.json

      - name: ğŸ“¤ Upload coverage summary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-summary-${{ github.sha }}
          path: coverage/summary.json
          retention-days: 90

      # main ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆ: baseline ã¨ã—ã¦ä¿å­˜
      - name: ğŸ’¾ Save baseline (main only)
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-baseline
          path: coverage/summary.json
          retention-days: 90

      # PR ã®å ´åˆ: baseline ã¨æ¯”è¼ƒ
      - name: ğŸ“¥ Download baseline
        if: github.event_name == 'pull_request'
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: coverage.yml
          branch: main
          name: coverage-baseline
          path: baseline/
        continue-on-error: true

      - name: ğŸ” Compare with baseline
        if: github.event_name == 'pull_request'
        id: compare
        run: |
          if [ -f "baseline/summary.json" ]; then
            BASE_LINES=$(jq '.lines' baseline/summary.json)
            BASE_BRANCHES=$(jq '.branches' baseline/summary.json)
            BASE_FUNCTIONS=$(jq '.functions' baseline/summary.json)
            BASE_STATEMENTS=$(jq '.statements' baseline/summary.json)

            CURRENT_LINES=${{ steps.coverage.outputs.lines }}
            CURRENT_BRANCHES=${{ steps.coverage.outputs.branches }}
            CURRENT_FUNCTIONS=${{ steps.coverage.outputs.functions }}
            CURRENT_STATEMENTS=${{ steps.coverage.outputs.statements }}

            # å·®åˆ†è¨ˆç®—
            DIFF_LINES=$(echo "$CURRENT_LINES - $BASE_LINES" | bc)
            DIFF_BRANCHES=$(echo "$CURRENT_BRANCHES - $BASE_BRANCHES" | bc)
            DIFF_FUNCTIONS=$(echo "$CURRENT_FUNCTIONS - $BASE_FUNCTIONS" | bc)
            DIFF_STATEMENTS=$(echo "$CURRENT_STATEMENTS - $BASE_STATEMENTS" | bc)

            echo "base_lines=$BASE_LINES" >> $GITHUB_OUTPUT
            echo "base_branches=$BASE_BRANCHES" >> $GITHUB_OUTPUT
            echo "base_functions=$BASE_FUNCTIONS" >> $GITHUB_OUTPUT
            echo "base_statements=$BASE_STATEMENTS" >> $GITHUB_OUTPUT

            echo "diff_lines=$DIFF_LINES" >> $GITHUB_OUTPUT
            echo "diff_branches=$DIFF_BRANCHES" >> $GITHUB_OUTPUT
            echo "diff_functions=$DIFF_FUNCTIONS" >> $GITHUB_OUTPUT
            echo "diff_statements=$DIFF_STATEMENTS" >> $GITHUB_OUTPUT

            echo "has_baseline=true" >> $GITHUB_OUTPUT

            # ä½ä¸‹ãƒã‚§ãƒƒã‚¯ï¼ˆ0.1%ä»¥ä¸Šã®ä½ä¸‹ã§failï¼‰
            THRESHOLD=-0.1
            FAIL=false

            if (( $(echo "$DIFF_LINES < $THRESHOLD" | bc -l) )); then
              echo "âŒ Lines coverage decreased: $DIFF_LINES%"
              FAIL=true
            fi
            if (( $(echo "$DIFF_BRANCHES < $THRESHOLD" | bc -l) )); then
              echo "âŒ Branches coverage decreased: $DIFF_BRANCHES%"
              FAIL=true
            fi
            if (( $(echo "$DIFF_FUNCTIONS < $THRESHOLD" | bc -l) )); then
              echo "âŒ Functions coverage decreased: $DIFF_FUNCTIONS%"
              FAIL=true
            fi
            if (( $(echo "$DIFF_STATEMENTS < $THRESHOLD" | bc -l) )); then
              echo "âŒ Statements coverage decreased: $DIFF_STATEMENTS%"
              FAIL=true
            fi

            if [ "$FAIL" = true ]; then
              echo "coverage_decreased=true" >> $GITHUB_OUTPUT
            else
              echo "coverage_decreased=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_baseline=false" >> $GITHUB_OUTPUT
            echo "coverage_decreased=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No baseline found. This PR will establish the baseline."
          fi

      - name: ğŸ’¬ PR Coverage Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const hasBaseline = '${{ steps.compare.outputs.has_baseline }}' === 'true';
            const decreased = '${{ steps.compare.outputs.coverage_decreased }}' === 'true';

            const formatDiff = (diff) => {
              const num = parseFloat(diff);
              if (isNaN(num)) return 'N/A';
              const sign = num >= 0 ? '+' : '';
              const emoji = num > 0 ? 'ğŸ“ˆ' : num < 0 ? 'ğŸ“‰' : 'â¡ï¸';
              return `${emoji} ${sign}${num.toFixed(2)}%`;
            };

            let body;

            if (hasBaseline) {
              body = `## ğŸ“Š Coverage Report

            | Metric | Current | Baseline | Diff |
            |--------|---------|----------|------|
            | **Lines** | ${{ steps.coverage.outputs.lines }}% | ${{ steps.compare.outputs.base_lines }}% | ${formatDiff('${{ steps.compare.outputs.diff_lines }}')} |
            | **Branches** | ${{ steps.coverage.outputs.branches }}% | ${{ steps.compare.outputs.base_branches }}% | ${formatDiff('${{ steps.compare.outputs.diff_branches }}')} |
            | **Functions** | ${{ steps.coverage.outputs.functions }}% | ${{ steps.compare.outputs.base_functions }}% | ${formatDiff('${{ steps.compare.outputs.diff_functions }}')} |
            | **Statements** | ${{ steps.coverage.outputs.statements }}% | ${{ steps.compare.outputs.base_statements }}% | ${formatDiff('${{ steps.compare.outputs.diff_statements }}')} |

            ---

            ${decreased
              ? 'âŒ **Coverage decreased!** Please add tests for the new/changed code.'
              : 'âœ… **Coverage maintained or improved!**'}

            <sub>ğŸ¤– BoxLog Coverage Bot</sub>`;
            } else {
              body = `## ğŸ“Š Coverage Report

            | Metric | Current |
            |--------|---------|
            | **Lines** | ${{ steps.coverage.outputs.lines }}% |
            | **Branches** | ${{ steps.coverage.outputs.branches }}% |
            | **Functions** | ${{ steps.coverage.outputs.functions }}% |
            | **Statements** | ${{ steps.coverage.outputs.statements }}% |

            ---

            âš ï¸ **No baseline found.** Once merged, this will become the baseline.

            <sub>ğŸ¤– BoxLog Coverage Bot</sub>`;
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c => c.body.includes('ğŸ“Š Coverage Report'));

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: âŒ Fail if coverage decreased
        if: github.event_name == 'pull_request' && steps.compare.outputs.coverage_decreased == 'true'
        run: |
          echo "âŒ Coverage has decreased below the threshold."
          echo "Please add tests to maintain or improve coverage."
          exit 1

      # å·®åˆ†ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰
      - name: ğŸ” Fetch base branch for diff
        if: github.event_name == 'pull_request'
        run: git fetch origin main:refs/remotes/origin/main

      - name: ğŸ“Š Diff Coverage Analysis
        if: github.event_name == 'pull_request'
        id: diff_coverage
        run: node scripts/diff-coverage.mjs
        continue-on-error: true

      - name: ğŸ’¬ Update PR comment with diff coverage
        if: github.event_name == 'pull_request' && steps.diff_coverage.outcome == 'failure'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c => c.body.includes('ğŸ“Š Coverage Report'));

            if (existingComment) {
              const updatedBody = existingComment.body + `

            ---

            ### âš ï¸ Diff Coverage Warning

            Some **critical files** (auth, server, supabase) in this PR have low test coverage.

            Critical files require **80%+** coverage. Please add tests.

            <sub>See workflow logs for details.</sub>`;

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: updatedBody
              });
            }

      - name: ğŸ“¤ Upload full coverage report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: coverage-report-${{ github.sha }}
          path: coverage/
          retention-days: 30
