name: ğŸ“„ Documentation Consistency Check

on:
  pull_request:
    branches: [main, dev]
    paths:
      - 'docs/**'
      - 'src/**'
      - 'scripts/docs-code-consistency.js'
      - 'package.json'
      - '.eslint/**'
  push:
    branches: [main, dev]
    paths:
      - 'docs/**'

env:
  NODE_VERSION: '18'

jobs:
  docs-consistency-check:
    name: ğŸ” Documentation Consistency Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Setup ESLint plugins
        run: npm run postinstall

      - name: ğŸ“„ Run documentation consistency check
        id: docs-check
        run: |
          npm run docs:check > docs-consistency-output.txt 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ“Š Upload consistency check results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-consistency-results
          path: docs-consistency-output.txt

      - name: ğŸ’¬ Comment PR with consistency results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const docsOutput = fs.readFileSync('docs-consistency-output.txt', 'utf8');

            // çµæœã®è§£æ
            const successMatch = docsOutput.match(/æˆåŠŸ: (\d+)\/(\d+)/);
            const warningMatch = docsOutput.match(/è­¦å‘Š: (\d+)\/(\d+)/);
            const errorMatch = docsOutput.match(/ã‚¨ãƒ©ãƒ¼: (\d+)\/(\d+)/);
            const scoreMatch = docsOutput.match(/æ•´åˆæ€§ã‚¹ã‚³ã‚¢: ([\d.]+)%/);

            const success = successMatch ? parseInt(successMatch[1]) : 0;
            const total = successMatch ? parseInt(successMatch[2]) : 0;
            const warnings = warningMatch ? parseInt(warningMatch[1]) : 0;
            const errors = errorMatch ? parseInt(errorMatch[1]) : 0;
            const score = scoreMatch ? parseFloat(scoreMatch[1]) : 0;

            let status = 'âœ… **è‰¯å¥½**';
            let priority = '';

            if (errors > 0) {
              status = 'ğŸš¨ **ä¿®æ­£å¿…è¦**';
              priority = '**Priority: High**';
            } else if (warnings > 5) {
              status = 'âš ï¸ **æ”¹å–„æ¨å¥¨**';
              priority = '**Priority: Medium**';
            }

            const comment = `## ğŸ“„ Documentation Consistency Check Results

            ${status} - æ•´åˆæ€§ã‚¹ã‚³ã‚¢: **${score.toFixed(1)}%** ${priority}

            ### ğŸ“Š è©³ç´°çµæœ
            - âœ… **æˆåŠŸ**: ${success}/${total} é …ç›®
            - âš ï¸ **è­¦å‘Š**: ${warnings}/${total} é …ç›®  
            - âŒ **ã‚¨ãƒ©ãƒ¼**: ${errors}/${total} é …ç›®

            ### ğŸ” ä¸»è¦ãƒã‚§ãƒƒã‚¯é …ç›®
            - ESLintè¨­å®šã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´åˆæ€§
            - Theme Systemã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´åˆæ€§
            - package.jsonã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´åˆæ€§
            - Markdownãƒªãƒ³ã‚¯åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
            - TODO/NOTEã®ä¸€è²«æ€§

            ${errors > 0 ? '### ğŸš¨ ä¿®æ­£ãŒå¿…è¦ãªå•é¡Œ\nã‚¨ãƒ©ãƒ¼é …ç›®ã®ä¿®æ­£ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚' : ''}
            ${warnings > 3 ? '### âš ï¸ æ”¹å–„ææ¡ˆ\nãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚' : ''}

            <details>
            <summary>ğŸ“‹ è©³ç´°ãƒ­ã‚°ã‚’è¡¨ç¤º</summary>

            \`\`\`
            ${docsOutput}
            \`\`\`

            </details>

            ---
            ğŸ”— [Full Analysis Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(comment => 
              comment.body.includes('ğŸ“„ Documentation Consistency Check Results')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: âŒ Fail if critical documentation issues found
        if: steps.docs-check.outputs.exit_code != '0'
        run: |
          echo "ğŸ“„ Documentation consistency check failed!"
          echo "Please review the consistency report above."
          exit 1
